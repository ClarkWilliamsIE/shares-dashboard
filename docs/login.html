<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Login</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    :root { color-scheme: dark; }
    body { margin: 0; padding: 14px; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial; background:#1e1e1e; color:#fff; }
    h2 { margin: 0 0 8px; font-size: 1.05rem; text-align: left; }
    .muted { opacity: 0.85; }
    .grid { display:grid; grid-template-columns: 1fr; gap: 10px; }
    input { padding: 10px 12px; background:#121212; border:1px solid #333; color:#fff; border-radius:6px; }
    .btn { padding: 10px 12px; background:#2a2a2a; border:1px solid #3a3a3a; color:#fff; border-radius:6px; cursor:pointer; }
    .btn:hover { background:#333; }
    .row { display:flex; gap:10px; }
    .help { margin-top: 6px; font-size: 12px; }
  </style>
</head>
<body>
  <h2>Sign in</h2>
  <div class="grid">
    <input id="email" type="email" placeholder="email@example.com" autocomplete="username" />
    <input id="password" type="password" placeholder="password" autocomplete="current-password" />
    <div class="row">
      <button id="btnSignIn" class="btn">Login</button>
      <button id="btnSignUp" class="btn">Sign up</button>
    </div>
    <div id="msg" class="help muted">Use your email and password to sign in</div>
  </div>

  <script>
    const SUPABASE_URL = "https://acdlgvcxzxjvcwiqlydj.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFjZGxndmN4enhqdmN3aXFseWRqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY2Mjc5NzksImV4cCI6MjA3MjIwMzk3OX0.9ZUURjJT73Igd2tAOv8aSZUmlkEf7DIzmOAGBSjWqCI";
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
      auth: { persistSession: true, autoRefreshToken: true, detectSessionInUrl: true }
    });

    const emailEl = document.getElementById('email');
    const passEl = document.getElementById('password');
    const btnSignIn = document.getElementById('btnSignIn');
    const btnSignUp = document.getElementById('btnSignUp');
    const msg = document.getElementById('msg');

    function setBusy(b) { btnSignIn.disabled = b; btnSignUp.disabled = b; emailEl.disabled = b; passEl.disabled = b; }
    function say(t) { msg.textContent = t; }

    function currentPageUrl() {
      const url = new URL(window.location.href);
      return url.origin + url.pathname;
    }

    btnSignIn.addEventListener('click', async () => {
      const email = emailEl.value.trim();
      const password = passEl.value;
      if (!email || !password) { say('Enter email and password'); return; }
      setBusy(true);
      const { error } = await supabase.auth.signInWithPassword({ email, password });
      setBusy(false);
      if (error) { say(error.message); }
      else {
        say('Logged in');
        window.parent && window.parent.postMessage({ type: 'authChanged' }, '*');
      }
    });

    btnSignUp.addEventListener('click', async () => {
      const email = emailEl.value.trim();
      const password = passEl.value;
      if (!email || !password) { say('Enter email and password'); return; }
      setBusy(true);
      const emailRedirectTo = currentPageUrl();
      const { error } = await supabase.auth.signUp({ email, password, options: { emailRedirectTo } });
      setBusy(false);
      if (error) { say(error.message); }
      else { say('Check your email to confirm, then come back to Login'); }
    });

    // If already logged in, tell parent to close
    (async function pingParentIfSignedIn() {
      const { data: { session } } = await supabase.auth.getSession();
      if (session && session.user) {
        window.parent && window.parent.postMessage({ type: 'authChanged' }, '*');
      }
    })();
  </script>
</body>
</html>
