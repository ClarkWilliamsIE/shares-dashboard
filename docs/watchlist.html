<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Watchlist Voting</title>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    :root { color-scheme: dark; }
    body { margin:0; background:#121212; color:#fff; font-family:system-ui, -apple-system, Segoe UI, Roboto, sans-serif; }
    header { display:flex; align-items:center; justify-content:space-between; padding:12px 16px; position:sticky; top:0; background:rgba(18,18,18,.9); border-bottom:1px solid #222; }
    h1 { font-size:1.05rem; margin:0; }
    main { padding:16px; max-width:960px; margin:0 auto; }
    .card { background:#1e1e1e; border:1px solid #2a2a2a; border-radius:12px; padding:14px; box-shadow:0 2px 12px rgba(0,0,0,.25); }
    .row { display:flex; gap:.5rem; align-items:center; flex-wrap:wrap; }
    .row input, .row textarea, .row select { background:#0f0f0f; color:#fff; border:1px solid #333; border-radius:10px; padding:.6rem .7rem; }
    .row textarea { width:100%; min-height:70px; resize:vertical; }
    .btn { padding:.55rem .8rem; border-radius:10px; border:1px solid #333; background:#1f2937; color:#fff; cursor:pointer; }
    .btn:hover { background:#273244; }
    .btn-cta { background:#2563eb; border-color:#2563eb; }
    .btn-cta:hover { background:#1d4ed8; }
    .grid { display:grid; grid-template-columns: 1fr; gap:.75rem; margin-top:1rem; }
    @media (min-width: 720px) { .grid { grid-template-columns: 1fr 1fr; } }
    .item { display:flex; gap:.75rem; align-items:flex-start; background:#171717; border:1px solid #262626; border-radius:12px; padding:12px; }
    .scorebox { min-width:84px; text-align:center; border:1px solid #333; border-radius:10px; padding:.35rem .5rem; background:#0f0f0f; }
    .score { font-size:1.25rem; font-weight:700; }
    .ticker { font-weight:700; letter-spacing:.5px; }
    .muted { color:#9aa0a6; font-size:.9rem; }
    .grow { flex:1; }
    .vote-row { display:flex; gap:.35rem; align-items:center; flex-wrap:wrap; }
    .vote { padding:.4rem .6rem; border-radius:10px; border:1px solid #333; background:#111; color:#fff; cursor:pointer; }
    .vote.up.active { border-color:#22c55e; }
    .vote.down.active { border-color:#ef4444; }
    .right { margin-left:auto; display:flex; gap:.5rem; }
    .danger { border-color:#ef4444; }
    .ok { color:#86efac; }
    .error { color:#fca5a5; }
    .topbar { display:flex; gap:.5rem; align-items:center; flex-wrap:wrap; margin-bottom:.75rem; }
  </style>
</head>
<body>
  <header>
    <h1>Watchlist Voting</h1>
    <div>
      <button class="btn" onclick="location.href='members.html'">Back to dashboard</button>
      <button class="btn danger" id="btnSignOut">Sign out</button>
    </div>
  </header>

  <main>
    <section class="card" style="margin-bottom:1rem;">
      <div class="topbar">
        <div class="row" style="flex:1;">
          <input id="ticker" placeholder="Ticker, for example AAPL" />
          <input id="notes" placeholder="Notes, for example why this is interesting" style="flex:1;" />
        </div>
        <button class="btn btn-cta" id="addBtn">Add to watchlist</button>
      </div>
      <div class="muted">Signed in users can add tickers. Everyone signed in can vote up or down. Highest score rises to the top.</div>
      <div id="msg" class="muted" style="margin-top:.5rem;"></div>
    </section>

    <section class="card">
      <div class="row" style="justify-content:space-between; margin-bottom:.5rem;">
        <div class="row">
          <label>Sort</label>
          <select id="sort">
            <option value="score">Score</option>
            <option value="new">Newest</option>
            <option value="ticker">Ticker</option>
          </select>
        </div>
        <div class="row">
          <label>Filter</label>
          <input id="search" placeholder="Type to filter tickers" />
        </div>
      </div>
      <div id="list" class="grid"></div>
    </section>
  </main>

  <script>
    const SUPABASE_URL = "https://acdlgvcxzxjvcwiqlydj.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFjZGxndmN4enhqdmN3aXFseWRqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY2Mjc5NzksImV4cCI6MjA3MjIwMzk3OX0.9ZUURjJT73Igd2tAOv8aSZUmlkEf7DIzmOAGBSjWqCI";
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    let currentUser = null;
    let items = [];
    let scores = [];
    let myVotes = [];

    async function guard() {
      const { data: { session } } = await supabase.auth.getSession();
      if (!session) { location.href = "login.html"; return; }
      const { data: { user } } = await supabase.auth.getUser();
      currentUser = user;
    }

    async function fetchAll() {
      const { data: itemsData, error: itemsErr } = await supabase
        .from("watchlist_items")
        .select("id, ticker, notes, created_at, created_by")
        .order("created_at", { ascending: false });
      if (itemsErr) throw itemsErr;
      items = itemsData || [];

      const { data: scoreData, error: scoreErr } = await supabase
        .from("watchlist_votes")
        .select("item_id, score:sum(value)")
        .group("item_id");
      if (scoreErr) throw scoreErr;
      scores = scoreData || [];

      const { data: myVoteData, error: myVoteErr } = await supabase
        .from("watchlist_votes")
        .select("item_id, value")
        .eq("user_id", currentUser.id);
      if (myVoteErr) throw myVoteErr;
      myVotes = myVoteData || [];
    }

    function merge() {
      const scoreMap = new Map(scores.map(s => [s.item_id, s.score || 0]));
      const myMap = new Map(myVotes.map(v => [v.item_id, v.value]));
      return items.map(it => ({
        ...it,
        score: scoreMap.get(it.id) || 0,
        myVote: myMap.get(it.id) || 0
      }));
    }

    function renderList() {
      const sort = document.getElementById("sort").value;
      const q = (document.getElementById("search").value || "").trim().toUpperCase();

      let merged = merge();
      if (q) merged = merged.filter(i => i.ticker.toUpperCase().includes(q));

      if (sort === "score") {
        merged.sort((a,b) => b.score - a.score || a.ticker.localeCompare(b.ticker));
      } else if (sort === "ticker") {
        merged.sort((a,b) => a.ticker.localeCompare(b.ticker));
      } else {
        merged.sort((a,b) => new Date(b.created_at) - new Date(a.created_at));
      }

      const list = document.getElementById("list");
      list.innerHTML = "";
      merged.forEach(it => {
        const el = document.createElement("div");
        el.className = "item";
        el.innerHTML = `
          <div class="scorebox">
            <div class="score">${it.score}</div>
            <div class="muted">score</div>
          </div>
          <div class="grow">
            <div class="ticker">${it.ticker}</div>
            <div class="muted">${it.notes ? it.notes : ""}</div>
          </div>
          <div class="right">
            <button class="vote up ${it.myVote === 1 ? "active" : ""}" data-id="${it.id}" data-v="1">▲</button>
            <button class="vote down ${it.myVote === -1 ? "active" : ""}" data-id="${it.id}" data-v="-1">▼</button>
          </div>
        `;
        list.appendChild(el);
      });

      document.querySelectorAll(".vote").forEach(btn => {
        btn.addEventListener("click", () => onVote(btn.dataset.id, parseInt(btn.dataset.v, 10)));
      });
    }

    async function onVote(itemId, v) {
      const current = myVotes.find(m => m.item_id === itemId);
      // If clicking same vote, remove vote
      if (current && current.value === v) {
        await supabase.from("watchlist_votes").delete().match({ item_id: itemId, user_id: currentUser.id });
      } else {
        await supabase.from("watchlist_votes").upsert(
          { item_id: itemId, user_id: currentUser.id, value: v },
          { onConflict: "item_id,user_id" }
        );
      }
      await fetchAll();
      renderList();
    }

    function showMsg(text, ok=true) {
      const m = document.getElementById("msg");
      m.textContent = text;
      m.className = ok ? "ok" : "error";
      setTimeout(() => { m.textContent = ""; m.className = "muted"; }, 1800);
    }

    async function addItem() {
      const t = document.getElementById("ticker").value.trim().toUpperCase();
      const n = document.getElementById("notes").value.trim();
      if (!t) { showMsg("Please enter a ticker", false); return; }
      try {
        const { error } = await supabase.from("watchlist_items").insert({ ticker: t, notes: n, created_by: currentUser.id });
        if (error) throw error;
        document.getElementById("ticker").value = "";
        document.getElementById("notes").value = "";
        showMsg("Added");
        await fetchAll();
        renderList();
      } catch (e) {
        showMsg(e.message || "Could not add", false);
      }
    }

    document.getElementById("addBtn").addEventListener("click", addItem);
    document.getElementById("sort").addEventListener("change", renderList);
    document.getElementById("search").addEventListener("input", renderList);
    document.getElementById("btnSignOut").addEventListener("click", async () => { await supabase.auth.signOut(); location.href = "login.html"; });

    async function init() {
      await guard();
      await fetchAll();
      renderList();
    }
    init();
  </script>
</body>
</html>

