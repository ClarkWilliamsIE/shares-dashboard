<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Winnerland</title>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- PapaParse -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.2/papaparse.min.js"></script>
  <!-- Supabase client -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    :root {
      --bg: #0f1115;
      --card: #151821;
      --text: #fff;
      --muted: #a9b0c0;
      --blue: #3b82f6;
      --green: #22c55e;
      --red: #ef4444;
      --ring: rgba(59,130,246,.4);
      --shadow: 0 8px 24px rgba(0,0,0,.35);
    }
    * { box-sizing: border-box; }
    body { margin: 0, padding: 24px, font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, Noto Sans, "Apple Color Emoji", "Segoe UI Emoji"; background: var(--bg); color: var(--text); }
    h1 { text-align: center, margin: 0 0 12px, letter-spacing: .5px; }

    .grid { display: grid, grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)), gap: 16px, margin-top: 16px; }
    .card { background: linear-gradient(180deg, #171a24, #141725), border: 1px solid rgba(255,255,255,.06), border-radius: 14px, box-shadow: var(--shadow), padding: 16px; }
    .card h2 { margin: 0 0 10px, font-size: 18px, text-align: center, font-weight: 600; }
    .chart { position: relative, height: 220px; }
    .chart canvas { width: 100% !important, height: 100% !important; }

    .auth { display: grid, gap: 10px, justify-items: center; }
    .auth .row { display: flex, flex-wrap: wrap, gap: 8px, justify-content: center; }
    .auth input { padding: 10px 12px, background: #0f1320, color: var(--text), border: 1px solid rgba(255,255,255,.08), border-radius: 10px, min-width: 220px, outline: none; }
    .auth input:focus { border-color: var(--blue), box-shadow: 0 0 0 3px var(--ring); }
    .seg { display: inline-flex, background: #0f1320, border: 1px solid rgba(255,255,255,.08), border-radius: 10px, overflow: hidden; }
    .seg button { padding: 8px 12px, background: transparent, color: var(--muted), border: 0, cursor: pointer; }
    .seg button.active { background: var(--blue), color: white; }
    .btn { padding: 10px 14px, border: 0, border-radius: 10px, cursor: pointer, box-shadow: var(--shadow); }
    .btn.primary { background: var(--blue), color: white; }
    .btn.danger { background: var(--red), color: white; }
    .pill { display: inline-flex, align-items: center, gap: 8px, padding: 6px 10px, background: #0f1320, border: 1px solid rgba(255,255,255,.08), border-radius: 999px, color: var(--muted); }
    .hidden { display: none !important; }

    .top { display: grid, gap: 14px, justify-items: center, margin-bottom: 8px; }
    .switch { position: relative, width: 50px, height: 26px; }
    .switch input { opacity: 0, width: 0, height: 0; }
    .slider { position: absolute, inset: 0, cursor: pointer, background: #2a3042, border-radius: 26px, transition: .2s; }
    .slider:before { content: "", position: absolute, height: 18px, width: 18px, left: 4px, bottom: 4px, background: white, border-radius: 999px, transition: .2s; }
    input:checked + .slider { background: var(--blue); }
    input:checked + .slider:before { transform: translateX(24px); }
  </style>
</head>
<body>
  <h1>Winnerland</h1>

  <div class="top">
    <div class="pill">
      <label class="switch">
        <input type="checkbox" id="memberToggle" />
        <span class="slider"></span>
      </label>
      <span>Member view</span>
    </div>

    <div id="authCard" class="card auth" style="max-width:880px, width:100%">
      <div class="row" id="authStatusRow">
        <span id="authStatus" class="pill">Not signed in</span>
        <label class="pill" style="cursor:pointer">
          <input id="rememberChk" type="checkbox" checked /> Stay signed in
        </label>
      </div>

      <div class="row" id="modeRow">
        <div class="seg">
          <button id="modeSignin" class="active" type="button">Sign in</button>
          <button id="modeSignup" type="button">Create account</button>
        </div>
      </div>

      <div id="authFormRow" class="row">
        <input id="emailInput" type="email" placeholder="email" />
        <input id="passwordInput" type="password" placeholder="password" />
        <input id="passwordConfirm" type="password" placeholder="confirm password" class="hidden" />
        <button id="authPrimaryBtn" class="btn primary" type="button">Sign in</button>
      </div>

      <div id="signedInRow" class="row hidden">
        <button id="signOutBtn" class="btn danger" type="button">Sign out</button>
      </div>
    </div>
  </div>

  <div class="grid" id="dashboard"></div>

  <script>
    // Supabase
    const supabaseUrl = "https://acdlgvcxzxjvcwiqlydj.supabase.co";
    const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFjZGxndmN4enhqdmN3aXFseWRqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY2Mjc5NzksImV4cCI6MjA3MjIwMzk3OX0.9ZUURjJT73Igd2tAOv8aSZUmlkEf7DIzmOAGBSjWqCI";
    function makeClient(persist) {
      return window.supabase.createClient(supabaseUrl, supabaseKey, {
        auth: { persistSession: persist, autoRefreshToken: true, detectSessionInUrl: true, storage: persist ? localStorage : sessionStorage }
      });
    }
    let supabase = makeClient(true);

    // Auth mode
    let authMode = "signin";
    function setMode(mode) {
      authMode = mode;
      document.getElementById("modeSignin").classList.toggle("active", mode === "signin");
      document.getElementById("modeSignup").classList.toggle("active", mode === "signup");
      document.getElementById("passwordConfirm").classList.toggle("hidden", mode !== "signup");
      document.getElementById("authPrimaryBtn").textContent = mode === "signin" ? "Sign in" : "Create account";
    }

    function persistFromUI() {
      const remember = document.getElementById("rememberChk");
      return remember ? !!remember.checked : true;
    }
    function swapClientForPersist() { supabase = makeClient(persistFromUI()); }

    async function updateAuthUI() {
      const { data: { user } } = await supabase.auth.getUser();
      const status = document.getElementById("authStatus");
      const authFormRow = document.getElementById("authFormRow");
      const modeRow = document.getElementById("modeRow");
      const signedInRow = document.getElementById("signedInRow");
      const signOutBtn = document.getElementById("signOutBtn");

      if (user) {
        status.textContent = `Signed in as ${user.email}`;
        authFormRow.classList.add("hidden");
        modeRow.classList.add("hidden");
        signedInRow.classList.remove("hidden");
        if (signOutBtn) signOutBtn.style.display = "inline-block";
      } else {
        status.textContent = "Not signed in";
        signedInRow.classList.add("hidden");
        modeRow.classList.remove("hidden");
        authFormRow.classList.remove("hidden");
        if (signOutBtn) signOutBtn.style.display = "none";
      }
    }

    supabase.auth.onAuthStateChange(() => updateAuthUI());
    document.getElementById("modeSignin").addEventListener("click", () => setMode("signin"));
    document.getElementById("modeSignup").addEventListener("click", () => setMode("signup"));

    document.getElementById("authPrimaryBtn").addEventListener("click", async () => {
      swapClientForPersist();
      const email = document.getElementById("emailInput").value.trim();
      const password = document.getElementById("passwordInput").value;
      if (!email || !password) { alert("Enter email and password"); return; }

      if (authMode === "signin") {
        const { error } = await supabase.auth.signInWithPassword({ email, password });
        if (error) alert(error.message);
      } else {
        const confirm = document.getElementById("passwordConfirm").value;
        if (password !== confirm) { alert("Passwords do not match"); return; }
        const { error } = await supabase.auth.signUp({ email, password, options: { emailRedirectTo: window.location.href } });
        if (error) alert(error.message); else alert("Check your email to confirm your account");
      }
    });

    document.getElementById("signOutBtn").addEventListener("click", async () => {
      await supabase.auth.signOut();
      updateAuthUI();
    });

    setMode("signin");
    updateAuthUI();

    // Charts
    const csvUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQEJMIKmxhiNNEJ8h-sgxpsSAT8ndO5TK0EVCijAoAv4y-cmmU0YSHFUX8mC6gMBouC9k50FVFQLawN/pub?gid=1666283294&single=true&output=csv";
    let rawRows = [];
    let portfolioData = [];

    Papa.parse(csvUrl, {
      download: true,
      header: true,
      complete: ({ data }) => {
        rawRows = data.filter(r => parseFloat(r["QTY"]) > 0 && r.Ticker);
        portfolioData = data.map(row => {
          const date = row["M"];
          const portfolioValue = parseFloat(row["N"]) || 0;
          if (!portfolioValue) return null;
          return { date, portfolioValue };
        }).filter(Boolean);
        renderCharts(false);
        const toggle = document.getElementById("memberToggle");
        if (toggle) toggle.addEventListener("change", e => renderCharts(e.target.checked));
      },
      error: err => console.error("CSV load error:", err)
    });

    function renderCharts(memberView) {
      const f = memberView ? 14 : 1;
      const dashboard = document.getElementById("dashboard");
      dashboard.innerHTML = "";

      let totalSpent = 0, totalValue = 0;
      rawRows.forEach(r => {
        const tcUsd = parseFloat(r["Total Cost"].replace(/[^\\d.-]/g,"")) || 0;
        const mvUsd = parseFloat(r["Market Value"].replace(/[^\\d.-]/g,"")) || 0;
        const mvNzd = parseFloat(r["NZD"].replace(/[^\\d.-]/g,"")) || 0;
        const costNzd = mvUsd ? tcUsd * (mvNzd / mvUsd) : 0;
        totalSpent += costNzd;
        totalValue += mvNzd;
      });
      const totalProfit = totalValue - totalSpent;

      const pieCard = document.createElement("div");
      pieCard.className = "card";
      pieCard.innerHTML = `
        <h2>Allocation ${memberView ? "(per member)" : ""}</h2>
        <div class="chart"><canvas id="summaryPie"></canvas></div>
      `;
      dashboard.appendChild(pieCard);

      const barCard = document.createElement("div");
      barCard.className = "card";
      barCard.innerHTML = `
        <h2>Portfolio Summary ${memberView ? "(per member)" : ""}</h2>
        <div class="chart"><canvas id="summaryBar"></canvas></div>
      `;
      dashboard.appendChild(barCard);

      const lineCard = document.createElement("div");
      lineCard.className = "card";
      lineCard.innerHTML = `
        <h2>Portfolio Value Over Time</h2>
        <div class="chart"><canvas id="portfolioValueLine"></canvas></div>
      `;
      dashboard.appendChild(lineCard);

      const lineLabels = portfolioData.map(r => r.date);
      const lineData = portfolioData.map(r => r.portfolioValue);
      const minValue = Math.min(...lineData);
      const maxValue = Math.max(...lineData);
      const margin = (maxValue - minValue) * 0.1;

      new Chart(document.getElementById("portfolioValueLine"), {
        type: "line",
        data: { labels: lineLabels, datasets: [{ label: "Portfolio Value (NZD)", data: lineData, fill: false, borderColor: "rgba(75,192,192,1)", tension: 0.1 }] },
        options: {
          responsive: true, maintainAspectRatio: false,
          scales: {
            y: { min: minValue - margin, max: maxValue + margin, ticks: { callback: v => "$" + v.toLocaleString(undefined, { minimumFractionDigits: 2 }) } },
            x: { }
          },
          plugins: { legend: { labels: { color: "#fff" } } }
        }
      });

      const pieLabels = rawRows.map(r => r.Ticker);
      const pieData = rawRows.map(r => (parseFloat(r["NZD"].replace(/[^\\d.-]/g,"")) || 0) / f);
      new Chart(document.getElementById("summaryPie"), {
        type: "doughnut",
        data: { labels: pieLabels, datasets: [{ data: pieData }] },
        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: "right", labels: { color: "#fff" } } }, elements: { arc: { borderWidth: 0 } } }
      });

      new Chart(document.getElementById("summaryBar"), {
        type: "bar",
        data: { labels: ["Spent", "Profit", "Value"], datasets: [{ label: "NZD", data: [ totalSpent / f, totalProfit / f, totalValue / f ], backgroundColor: ["rgba(54,162,235,0.6)","rgba(255,205,86,0.6)","rgba(75,192,192,0.6)"] }] },
        options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, ticks: { callback: v => "$" + v.toLocaleString(undefined, { minimumFractionDigits: 2 }) } } }, plugins: { legend: { display: false } } }
      });

      rawRows.forEach(r => {
        const tcUsd = parseFloat(r["Total Cost"].replace(/[^\\d.-]/g, "")) || 0;
        const mvUsd = parseFloat(r["Market Value"].replace(/[^\\d.-]/g, "")) || 0;
        const mvNzd = parseFloat(r["NZD"].replace(/[^\\d.-]/g, "")) || 0;
        const costNzd = mvUsd ? tcUsd * (mvNzd / mvUsd) : 0;
        const profitNzd = mvNzd - costNzd;
        const pctChange = parseFloat(r["% Change"].replace(/[^\\d.-]/g, "")) || 0;

        const card = document.createElement("div");
        card.className = "card";
        card.style.border = `1px solid ${profitNzd >= 0 ? "rgba(34,197,94,.35)" : "rgba(239,68,68,.35)"} `;
        card.innerHTML = `
          <h2>${r.Ticker}</h2>
          <div class="chart"><canvas id="chart-${r.Ticker}"></canvas></div>
        `;
        dashboard.appendChild(card);

        new Chart(document.getElementById(`chart-${r.Ticker}`), {
          data: {
            labels: ["Cost", "Value", "Profit", "% Change"],
            datasets: [
              { type: "bar", label: "NZD", data: [ costNzd / f, mvNzd / f, profitNzd / f, null ], backgroundColor: ["rgba(54,162,235,0.6)","rgba(75,192,192,0.6)","rgba(255,205,86,0.6)"] },
              { type: "line", label: "% Change", data: [ null, null, null, pctChange ], yAxisID: "PCT", borderColor: "rgba(255,99,132,0.8)", backgroundColor: "rgba(255,99,132,0.4)", tension: .3, pointRadius: 4, fill: false }
            ]
          },
          options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, title: { display: true, text: "NZD" }, ticks: { callback: v => "$" + v.toLocaleString() } }, PCT: { type: "linear", position: "right", title: { display: true, text: "% Change" }, grid: { drawOnChartArea: false }, ticks: { callback: v => v + "%" } } }, plugins: { legend: { position: "bottom" } } }
        });
      });
    }
  </script>
</body>
</html>

