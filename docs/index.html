<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Winnerland, Main</title>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.2/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    :root { color-scheme: dark; }
    body { margin: 0; padding: 1rem; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial; background: #121212; color: #fff; }
    h1 { text-align: center; margin-bottom: 0.5rem; color: #fff; }

    .topbar { display: flex; align-items: center; justify-content: center; gap: 1rem; flex-wrap: wrap; }
    .stack { display: flex; align-items: center; gap: 0.5rem; }
    .btn { padding: 0.45rem 0.7rem; background: #2a2a2a; border: 1px solid #3a3a3a; color: #fff; border-radius: 6px; cursor: pointer; }
    .btn:hover { background: #333; }
    .muted { opacity: 0.85; }

    .gate { max-width: 1024px; margin: 1rem auto; }
    .dashboard { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1rem; margin-top: 1rem; }
    .chart-card { background: #1e1e1e; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.25); padding: 1rem; display: flex; flex-direction: column; border: 3px solid transparent; }
    .chart-card h2 { margin: 0 0 0.5rem; font-size: 1.1rem; text-align: center; color: #fff; }
    .chart-container { position: relative; flex: 1; height: 200px; }
    .chart-container canvas { width: 100% !important; height: 100% !important; }
    #log { max-width: 1024px; margin: 1rem auto; background: #0f0f0f; border: 1px solid #333; padding: 0.5rem 0.75rem; border-radius: 8px; white-space: pre-wrap; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size: 12px; }

    /* Modal */
    .modal-backdrop { position: fixed; inset: 0; background: rgba(0,0,0,0.6); display: none; align-items: center; justify-content: center; z-index: 1000; }
    .modal { width: min(520px, 92vw); background: #1e1e1e; border: 1px solid #333; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.45); }
    .modal header { display:flex; align-items:center; justify-content: space-between; padding: 10px 12px; border-bottom: 1px solid #2a2a2a; }
    .modal header h3 { margin: 0; font-size: 1rem; }
    .modal .close { background: transparent; border: 0; color: #bbb; font-size: 20px; cursor: pointer; }
    .modal .body { padding: 0; }
    .modal iframe { width: 100%; height: 360px; border: 0; border-radius: 0 0 12px 12px; }
  </style>
</head>
<body>
  <h1>Winnerland</h1>

  <!-- Top controls -->
  <div class="topbar">
    <div class="stack">
      <button id="btnLogin" class="btn">Login to access member tools</button>
      <button id="btnSignOut" class="btn" style="display:none;">Sign out</button>
    </div>
    <div class="stack">
      <span id="authStatus" class="muted">Not signed in</span>
    </div>
  </div>

  <!-- Member tools, only when signed in -->
  <div id="proFeatures" class="gate" style="display:none;">
    <div class="chart-card">
      <h2>Member tools</h2>
      <p class="muted" style="text-align:center; margin-top: -0.25rem;">You are signed in, tools appear below</p>
    </div>

    <!-- Watchlist inside Member tools -->
    <div class="chart-card">
      <h2>Shared watchlist</h2>
      <iframe
        id="watchlistFrame"
        src="./watchlist.html"
        title="Shared watchlist"
        style="width:100%; border:0; min-height:360px; border-radius:8px; overflow:hidden;"
        loading="lazy"
        referrerpolicy="same-origin"
        sandbox="allow-same-origin allow-scripts allow-forms"
      ></iframe>
    </div>
  </div>

  <!-- Public charts -->
  <div class="dashboard" id="dashboard"></div>

  <!-- Log -->
  <div id="log">Status, loading...</div>

  <!-- Login modal -->
  <div id="loginBackdrop" class="modal-backdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="loginTitle">
      <header>
        <h3 id="loginTitle">Member login</h3>
        <button class="close" id="closeLogin" aria-label="Close">Ã—</button>
      </header>
      <div class="body">
        <iframe id="loginFrame" src="./login.html" title="Login form" referrerpolicy="same-origin" sandbox="allow-same-origin allow-scripts allow-forms"></iframe>
      </div>
    </div>
  </div>

  <script>
    /* Logger */
    const logBox = document.getElementById('log');
    function logLine(msg) { console.log(msg); if (logBox) logBox.textContent += "\\n" + msg; }
    logBox.textContent = "Status, booting app...";

    /* Supabase config */
    const SUPABASE_URL = "https://acdlgvcxzxjvcwiqlydj.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFjZGxndmN4enhqdmN3aXFseWRqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY2Mjc5NzksImV4cCI6MjA3MjIwMzk3OX0.9ZUURjJT73Igd2tAOv8aSZUmlkEf7DIzmOAGBSjWqCI";
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
      auth: { persistSession: true, autoRefreshToken: true, detectSessionInUrl: true }
    });

    /* Elements */
    const authStatus = document.getElementById('authStatus');
    const btnLogin = document.getElementById('btnLogin');
    const btnSignOut = document.getElementById('btnSignOut');
    const proFeatures = document.getElementById('proFeatures');
    const dashboard = document.getElementById('dashboard');

    /* Modal helpers */
    const backdrop = document.getElementById('loginBackdrop');
    const closeLogin = document.getElementById('closeLogin');
    function openLogin() { backdrop.style.display = 'flex'; backdrop.setAttribute('aria-hidden','false'); }
    function closeLoginModal() { backdrop.style.display = 'none'; backdrop.setAttribute('aria-hidden','true'); }

    btnLogin.addEventListener('click', openLogin);
    closeLogin.addEventListener('click', closeLoginModal);
    backdrop.addEventListener('click', e => { if (e.target === backdrop) closeLoginModal(); });

    /* Auth UI */
    async function refreshAuthUI() {
      const { data: { session } } = await supabase.auth.getSession();
      const signedIn = !!(session && session.user);
      authStatus.textContent = signedIn ? `Signed in as ${session.user.email}` : 'Not signed in';
      btnSignOut.style.display = signedIn ? 'inline-block' : 'none';
      btnLogin.style.display = signedIn ? 'none' : 'inline-block';
      proFeatures.style.display = signedIn ? 'block' : 'none';
    }
    function cleanAuthHashOnce() {
      if (window.location.hash && window.location.hash.includes("access_token")) {
        history.replaceState({}, document.title, window.location.pathname + window.location.search);
        logLine("Cleaned auth hash");
      }
    }
    supabase.auth.onAuthStateChange(() => { refreshAuthUI(); cleanAuthHashOnce(); });

    btnSignOut.addEventListener('click', async () => {
      await supabase.auth.signOut();
      logLine("Signed out");
    });

    /* Receive messages from iframes */
    window.addEventListener('message', evt => {
      const data = evt.data || {};
      if (data.type === 'watchlistHeight') {
        const frame = document.getElementById('watchlistFrame');
        if (frame) frame.style.height = Math.max(360, Number(data.height) || 360) + 'px';
      }
      if (data.type === 'authChanged') {
        closeLoginModal();
        refreshAuthUI();
        logLine("Auth changed, closing login modal");
      }
    }, false);

    /* Charts */
    const csvUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQEJMIKmxhiNNEJ8h-sgxpsSAT8ndO5TK0EVCijAoAv4y-cmmU0YSHFUX8mC6gMBouC9k50FVFQLawN/pub?gid=1666283294&single=true&output=csv';
    let rawRows = [];
    let portfolioData = [];

    function numFromCell(val) { if (val == null) return 0; return parseFloat(String(val).replace(/[^\d.-]/g,'')) || 0; }
    function safeTickerId(t) { return String(t || 'TICKER').replace(/[^A-Za-z0-9_-]/g, '_'); }
    function buildPortfolioFromHeaders(rows) {
      let dateKey = null, valueKey = null;
      const headers = rows.length ? Object.keys(rows[0]) : [];
      const datePrefs = ['Date','date','M'];
      const valuePrefs = ['Portfolio Value','portfolio value','Value','N'];
      for (const k of datePrefs) if (headers.includes(k)) { dateKey = k; break; }
      for (const k of valuePrefs) if (headers.includes(k)) { valueKey = k; break; }
      if (!dateKey || !valueKey) return [];
      return rows.map(r => {
        const date = r[dateKey];
        const v = numFromCell(r[valueKey]);
        if (!date || !isFinite(v) || v <= 0) return null;
        return { date, portfolioValue: v };
      }).filter(Boolean);
    }
    function ensureDemoWhenEmpty() {
      const needDemo = portfolioData.length === 0 && rawRows.length === 0;
      if (!needDemo) return;
      logLine("CSV looked empty or mismatched, using demo data so charts show");
      rawRows = [
        { Ticker: 'AAPL', 'Total Cost': '1000', 'Market Value': '1200', 'NZD': '2000', '% Change': '20', QTY: '1' },
        { Ticker: 'MSFT', 'Total Cost': '800', 'Market Value': '900', 'NZD': '1500', '% Change': '12.5', QTY: '1' }
      ];
      portfolioData = [
        { date: '2025-07', portfolioValue: 2600 },
        { date: '2025-08', portfolioValue: 2950 },
        { date: '2025-09', portfolioValue: 3100 }
      ];
    }
    function loadCsvAndRender() {
      logLine("Loading CSV, " + csvUrl);
      Papa.parse(csvUrl, {
        download: true,
        header: true,
        skipEmptyLines: true,
        complete: ({ data }) => {
          try {
            const rows = Array.isArray(data) ? data : [];
            rawRows = rows.filter(r => numFromCell(r['QTY']) > 0 && r['Ticker']);
            portfolioData = buildPortfolioFromHeaders(rows);
            ensureDemoWhenEmpty();
            logLine("CSV parsed, holdings " + rawRows.length + ", points " + portfolioData.length);
            renderCharts(false);
          } catch (e) {
            logLine("Parse error, " + e.message);
            ensureDemoWhenEmpty();
            renderCharts(false);
          }
        },
        error: err => {
          logLine("CSV load error, " + err);
          ensureDemoWhenEmpty();
          renderCharts(false);
        }
      });
    }
    function renderCharts(memberView) {
      const f = memberView ? 14 : 1;
      dashboard.innerHTML = '';

      let totalSpent = 0, totalValue = 0;
      rawRows.forEach(r => {
        const tcUsd   = numFromCell(r['Total Cost']);
        const mvUsd   = numFromCell(r['Market Value']);
        const mvNzd   = numFromCell(r['NZD']);
        const costNzd = mvUsd ? tcUsd * (mvNzd / mvUsd) : 0;
        totalSpent += costNzd;
        totalValue += mvNzd;
      });
      const totalProfit = totalValue - totalSpent;

      const pieCard = document.createElement('div');
      pieCard.className = 'chart-card';
      pieCard.innerHTML = `<h2>Allocation ${memberView ? '(per member NZD)' : ''}</h2><div class="chart-container"><canvas id="summaryPie"></canvas></div>`;
      dashboard.appendChild(pieCard);

      const barCard = document.createElement('div');
      barCard.className = 'chart-card';
      barCard.innerHTML = `<h2>Portfolio Summary ${memberView ? '(per member NZD)' : ''}</h2><div class="chart-container"><canvas id="summaryBar"></canvas></div>`;
      dashboard.appendChild(barCard);

      const lineCard = document.createElement('div');
      lineCard.className = 'chart-card';
      lineCard.innerHTML = `<h2>Portfolio Value Over Time</h2><div class="chart-container"><canvas id="portfolioValueLine"></canvas></div>`;
      dashboard.appendChild(lineCard);

      const lineLabels = portfolioData.map(r => r.date);
      const lineVals = portfolioData.map(r => r.portfolioValue);
      if (lineVals.length) {
        const minValue = Math.min.apply(null, lineVals);
        const maxValue = Math.max.apply(null, lineVals);
        const margin = Math.max(1, (maxValue - minValue) * 0.1);
        try {
          new Chart(document.getElementById('portfolioValueLine'), {
            type: 'line',
            data: { labels: lineLabels, datasets: [{ label: 'Portfolio Value (NZD)', data: lineVals, fill: false, borderColor: 'rgba(75,192,192,1)', tension: 0.1 }] },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              scales: {
                y: { min: minValue - margin, max: maxValue + margin,
                     ticks: { callback: v => '$' + Number(v).toLocaleString(undefined, { minimumFractionDigits: 2 }) },
                     grid: { color: '#444', borderColor: '#444' } },
                x: { grid: { color: '#444' } }
              },
              plugins: { legend: { labels: { color: '#fff' } } }
            }
          });
        } catch (e) { logLine("Line chart error, " + e.message); }
      }

      const pieLabels = rawRows.length ? rawRows.map(r => r.Ticker) : ['None'];
      const pieData = rawRows.length ? rawRows.map(r => numFromCell(r['NZD']) / f) : [1];
      try {
        new Chart(document.getElementById('summaryPie'), {
          type: 'doughnut',
          data: { labels: pieLabels, datasets: [{ data: pieData }] },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { position: 'right', labels: { color: '#fff' } } },
            elements: { arc: { borderWidth: 0 } }
          }
        });
      } catch (e) { logLine("Pie chart error, " + e.message); }

      try {
        new Chart(document.getElementById('summaryBar'), {
          type: 'bar',
          data: { labels: ['Spent', 'Profit', 'Value'],
                  datasets: [{ label: 'NZD', data: [ totalSpent / f, totalProfit / f, totalValue / f ],
                               backgroundColor: [ 'rgba(54,162,235,0.6)', 'rgba(255,205,86,0.6)', 'rgba(75,192,192,0.6)' ] }] },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              y: { beginAtZero: true, ticks: { callback: v => '$' + Number(v).toLocaleString(undefined, { minimumFractionDigits: 2 }) }, grid: { color: '#444', borderColor: '#444' } },
              x: { grid: { color: '#444' } }
            },
            plugins: { legend: { display: false } }
          }
        });
      } catch (e) { logLine("Bar chart error, " + e.message); }

      rawRows.forEach(r => {
        const tcUsd = numFromCell(r['Total Cost']);
        const mvUsd = numFromCell(r['Market Value']);
        const mvNzd = numFromCell(r['NZD']);
        const costNzd = mvUsd ? tcUsd * (mvNzd / mvUsd) : 0;
        const profitNzd = mvNzd - costNzd;
        const pctChange = numFromCell(r['% Change']);

        const card = document.createElement('div');
        card.className = 'chart-card';
        const elId = "chart_" + safeTickerId(r.Ticker);
        card.innerHTML = `<h2>${r.Ticker}</h2><div class="chart-container"><canvas id="${elId}"></canvas></div>`;
        card.style.border = profitNzd >= 0 ? '3px solid #28a745' : '3px solid #dc3545';
        dashboard.appendChild(card);

        try {
          new Chart(document.getElementById(elId), {
            data: {
              labels: ['Cost', 'Value', 'Profit', '% Change'],
              datasets: [
                { type: 'bar', label: 'NZD', data: [ costNzd / f, mvNzd / f, profitNzd / f, null ],
                  backgroundColor: [ 'rgba(54,162,235,0.6)', 'rgba(75,192,192,0.6)', 'rgba(255,205,86,0.6)' ] },
                { type: 'line', label: '% Change', data: [ null, null, null, pctChange ], yAxisID: 'PCT',
                  borderColor: 'rgba(255,99,132,0.8)', backgroundColor: 'rgba(255,99,132,0.4)', tension: 0.3, pointRadius: 4, fill: false }
              ]
            },
            options: {
              responsive: true, maintainAspectRatio: false,
              scales: {
                y: { beginAtZero: true, title: { display: true, text: 'NZD' }, ticks: { callback: v => '$' + Number(v).toLocaleString() }, grid: { color: '#444' } },
                PCT: { type: 'linear', position: 'right', title: { display: true, text: '% Change' }, grid: { drawOnChartArea: false }, ticks: { callback: v => v + '%' } }
              },
              plugins: {
                tooltip: { callbacks: { label: ctx => ctx.dataset.type === 'line' ? `% Change: ${ctx.parsed.y}%` : `NZD $${Number(ctx.parsed.y).toLocaleString()}` } },
                legend: { position: 'bottom' }
              }
            }
          });
        } catch (e) { logLine("Holding chart error for " + r.Ticker + ", " + e.message); }
      });
    }

    /* Init */
    (async function init() {
      try {
        await refreshAuthUI();
        cleanAuthHashOnce();
        loadCsvAndRender();
        logLine("Init done");
      } catch (e) {
        logLine("Init error, " + e.message);
      }
    })();
  </script>
</body>
</html>


