<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Winnerland</title>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- PapaParse -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.2/papaparse.min.js"></script>
  <!-- Supabase JS v2 -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    :root { color-scheme: dark; }
    body {
      margin: 0; padding: 1rem;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background: #121212; color: #fff;
    }
    h1 { text-align: center; margin-bottom: 0.5rem; }
    .switch { position: relative; display: inline-block; width: 50px; height: 26px; margin-right: 0.5rem; }
    .switch input { opacity: 0; width: 0; height: 0; }
    .slider { position: absolute; cursor: pointer; inset: 0; background-color: #3a3a3a; transition: .2s; border-radius: 26px; }
    .slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 4px; bottom: 4px; background-color: white; transition: .2s; border-radius: 50%; }
    input:checked + .slider { background-color: #2196F3; }
    input:checked + .slider:before { transform: translateX(24px); }
    .topbar { display: flex; align-items: center; justify-content: center; gap: 1rem; flex-wrap: wrap; }
    .stack { display: flex; align-items: center; gap: 0.5rem; }
    .auth { display: grid; grid-template-columns: repeat(6, max-content); gap: 0.5rem; justify-content: center; margin-top: 0.5rem; }
    .auth input { padding: 0.45rem 0.6rem; background: #1e1e1e; border: 1px solid #333; color: #fff; border-radius: 6px; }
    .btn { padding: 0.45rem 0.7rem; background: #2a2a2a; border: 1px solid #3a3a3a; color: #fff; border-radius: 6px; cursor: pointer; }
    .btn:hover { background: #333; }
    .muted { opacity: 0.85; }
    .dashboard { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1rem; margin-top: 1rem; }
    .chart-card { background: #1e1e1e; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.25); padding: 1rem; display: flex; flex-direction: column; border: 3px solid transparent; }
    .chart-card h2 { margin: 0 0 0.5rem; font-size: 1.1rem; text-align: center; }
    .chart-container { position: relative; flex: 1; height: 200px; }
    .gate { max-width: 1024px; margin: 1rem auto; }
    #log { max-width: 1024px; margin: 1rem auto; background: #0f0f0f; border: 1px solid #333; padding: 0.5rem 0.75rem; border-radius: 8px; font-size: 12px; white-space: pre-wrap; }
    #watchlistTable th, #watchlistTable td { border-bottom: 1px solid #2a2a2a; }
    #watchlistTable tr:hover { background: #161616; }
    .pill { display: inline-block; padding: 0.1rem 0.5rem; border-radius: 999px; background: #222; border: 1px solid #333; font-size: 12px; }
  </style>
</head>
<body>
  <h1>Winnerland</h1>

  <!-- Top controls -->
  <div class="topbar">
    <div class="stack">
      <label class="switch">
        <input type="checkbox" id="memberToggle" />
        <span class="slider"></span>
      </label>
      <span>Member view</span>
    </div>
    <div class="stack"><span id="authStatus" class="muted">Not signed in</span></div>
  </div>

  <!-- Auth controls -->
  <div class="auth">
    <input id="email" type="email" placeholder="email@example.com" autocomplete="username" />
    <input id="password" type="password" placeholder="password" autocomplete="current-password" />
    <button id="btnSignUp" class="btn">Sign up</button>
    <button id="btnSignIn" class="btn">Login</button>
    <button id="btnSignOut" class="btn" style="display:none;">Sign out</button>
  </div>

  <!-- Member area -->
  <div id="proFeatures" class="gate" style="display:none;">
    <div class="chart-card"><h2>Member tools</h2><p class="muted" style="text-align:center;">You are signed in.</p></div>
  </div>

  <!-- Watchlist card -->
  <div id="watchlistCard" class="gate">
    <div class="chart-card">
      <h2>Shared watchlist</h2>
      <form id="watchlistForm" class="auth" style="grid-template-columns: repeat(5, max-content); display:none; margin-bottom: 0.5rem;">
        <input id="wlTicker" type="text" placeholder="Ticker e.g. AAPL" />
        <input id="wlCost" type="number" step="0.0001" min="0" placeholder="Cost price e.g. 123.45" />
        <button id="wlAdd" type="submit" class="btn">Add</button>
        <span class="muted" style="align-self:center;">Signed in can add, everyone can view</span>
      </form>
      <div style="overflow:auto;">
        <table id="watchlistTable" style="width:100%; border-collapse: collapse;">
          <thead><tr><th>Ticker</th><th>Cost</th><th>Added by</th><th>When</th><th>Action</th></tr></thead>
          <tbody id="watchlistBody"><tr><td colspan="5" class="muted" style="padding:8px;">Loading...</td></tr></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Log -->
  <div id="log">Booting...</div>
  <div class="dashboard" id="dashboard"></div>

<script>
/* ---------------- Settings ---------------- */
const SUPABASE_URL = "https://acdlgvcxzxjvcwiqlydj.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOi..."; // your anon key
const SHEETS_WEBHOOK_URL = "https://script.google.com/macros/s/XXXX/exec"; // your Apps Script web app URL
const SHEETS_WEBHOOK_SECRET = "watchlist"; // same secret as in Apps Script

const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

/* ---------------- Logger ---------------- */
const logBox = document.getElementById('log');
function logLine(msg){ console.log(msg); logBox.textContent += "\n"+msg; }

/* ---------------- Auth ---------------- */
const authStatus = document.getElementById('authStatus');
const btnSignUp = document.getElementById('btnSignUp');
const btnSignIn = document.getElementById('btnSignIn');
const btnSignOut = document.getElementById('btnSignOut');
const emailEl = document.getElementById('email');
const passEl = document.getElementById('password');
const proFeatures = document.getElementById('proFeatures');
const memberToggle = document.getElementById('memberToggle');

async function refreshAuthUI(){
  const { data: { session } } = await supabase.auth.getSession();
  const signedIn = !!(session && session.user);
  authStatus.textContent = signedIn ? `Signed in as ${session.user.email}` : 'Not signed in';
  btnSignOut.style.display = signedIn ? 'inline-block' : 'none';
  btnSignIn.style.display = signedIn ? 'none' : 'inline-block';
  btnSignUp.style.display = signedIn ? 'none' : 'inline-block';
  emailEl.style.display = signedIn ? 'none' : 'inline-block';
  passEl.style.display = signedIn ? 'none' : 'inline-block';
  proFeatures.style.display = signedIn ? 'block' : 'none';
  wlForm.style.display = signedIn ? 'grid' : 'none';
  currentUser = signedIn ? session.user : null;
}
supabase.auth.onAuthStateChange(()=>refreshAuthUI());

btnSignUp.onclick = async ()=>{
  const email=emailEl.value.trim(), password=passEl.value;
  if(!email||!password){alert("Enter email & password"); return;}
  const { error } = await supabase.auth.signUp({ email,password,options:{emailRedirectTo:location.href}});
  if(error) alert(error.message); else alert("Check your email for confirm link");
};
btnSignIn.onclick = async ()=>{
  const email=emailEl.value.trim(), password=passEl.value;
  if(!email||!password){alert("Enter email & password"); return;}
  const { error } = await supabase.auth.signInWithPassword({ email,password });
  if(error) alert(error.message);
};
btnSignOut.onclick = ()=>supabase.auth.signOut();

/* ---------------- Watchlist ---------------- */
const wlForm=document.getElementById('watchlistForm');
const wlTicker=document.getElementById('wlTicker');
const wlCost=document.getElementById('wlCost');
const wlAddBtn=document.getElementById('wlAdd');
const wlBody=document.getElementById('watchlistBody');
let currentUser=null;

async function loadWatchlist(){
  const { data, error } = await supabase.from('watchlist').select('*').order('created_at',{ascending:false});
  if(error){ wlBody.innerHTML=`<tr><td colspan=5>Error ${error.message}</td></tr>`; return;}
  if(!data.length){ wlBody.innerHTML=`<tr><td colspan=5>No items</td></tr>`; return;}
  wlBody.innerHTML=data.map(r=>{
    const who=r.added_by_email||'member';
    const when=new Date(r.created_at).toLocaleString();
    const price=Number(r.cost_price).toLocaleString();
    const del=(currentUser && currentUser.id===r.added_by)?`<button class="btn" data-del="${r.id}">Delete</button>`:`<span class="pill">View</span>`;
    return `<tr><td>${r.ticker}</td><td style="text-align:right">$${price}</td><td>${who}</td><td>${when}</td><td>${del}</td></tr>`;
  }).join('');
  wlBody.querySelectorAll('[data-del]').forEach(btn=>{
    btn.onclick=async()=>{await supabase.from('watchlist').delete().eq('id',btn.dataset.del);}
  });
}
wlForm.onsubmit=async e=>{
  e.preventDefault();
  if(!currentUser){alert("Sign in first");return;}
  const ticker=wlTicker.value.trim().toUpperCase(), cost=Number(wlCost.value);
  if(!ticker||!cost){alert("Enter ticker and cost");return;}
  wlAddBtn.disabled=true;
  const { data:sessionData } = await supabase.auth.getSession();
  const email=sessionData.session.user.email;
  const { data, error } = await supabase.from('watchlist').insert({ticker, cost_price:cost, added_by:currentUser.id, added_by_email:email}).select().limit(1);
  wlAddBtn.disabled=false;
  if(error){alert(error.message);return;}
  wlTicker.value=''; wlCost.value='';
  // forward to Sheets
  try{
    await fetch(SHEETS_WEBHOOK_URL,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({secret:SHEETS_WEBHOOK_SECRET,created_at:new Date().toISOString(),ticker, cost_price:cost, added_by_email:email})});
    logLine("Forwarded to Google Sheets");
  }catch(err){ logLine("Sheets error "+err.message); }
};
supabase.channel('public:watchlist').on('postgres_changes',{event:'*',schema:'public',table:'watchlist'},loadWatchlist).subscribe();

/* ---------------- Init ---------------- */
(async()=>{ await refreshAuthUI(); loadWatchlist(); logLine("Ready"); })();
</script>
</body>
</html>

