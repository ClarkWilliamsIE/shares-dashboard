<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Winnerland!</title>

  <!-- 1) Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- 2) Flowbite CSS -->
  <link
    href="https://cdnjs.cloudflare.com/ajax/libs/flowbite/2.5.2/flowbite.min.css"
    rel="stylesheet"
  />

  <!-- 3) ApexCharts (for Flowbite Charts) -->
  <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>

  <!-- 4) Flowbite JS (includes Charts plugin) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/flowbite/2.5.2/flowbite.bundle.min.js"></script>

  <!-- 5) PapaParse (CSV parsing) -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.2/papaparse.min.js"></script>
</head>

<body class="bg-gray-900 text-white p-4 font-sans">
  <h1 class="text-3xl text-center mb-4">Winnerland!</h1>

  <div class="text-center mb-4">
    <label class="inline-flex items-center cursor-pointer">
      <input id="memberToggle" type="checkbox" class="sr-only peer" />
      <div
        class="w-12 h-6 bg-gray-700 rounded-full peer-checked:bg-blue-600 transition-colors"
      ></div>
      <span class="ml-2">Member view</span>
    </label>
  </div>

  <div id="dashboard" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4"></div>

  <script>
    const csvUrl =
      'https://docs.google.com/spreadsheets/d/e/2PACX-1vQEJMIKmxhiNNEJ8h-sgxpsSAT8ndO5TK0EVCijAoAv4y-cmmU0YSHFUX8mC6gMBouC9k50FVFQLawN/pub?gid=1666283294&single=true&output=csv';

    let rawRows = [], portfolioData = [];

    // 1) Parse CSV
    Papa.parse(csvUrl, {
      download: true,
      header: true,
      complete: ({ data }) => {
        rawRows = data.filter(r => parseFloat(r.QTY) > 0 && r.Ticker);

        portfolioData = data
          .map(row => {
            const v = parseFloat(row.N) || 0;
            return v ? { date: row.M, value: v } : null;
          })
          .filter(r => r);

        // initial render
        renderCharts(false);

        // re-render on toggle
        document
          .getElementById('memberToggle')
          .addEventListener('change', e => renderCharts(e.target.checked));
      },
      error: err => console.error('CSV load error:', err)
    });

    // 2) Render all charts
    function renderCharts(memberView) {
      const f = memberView ? 14 : 1;
      const dash = document.getElementById('dashboard');
      dash.innerHTML = '';

      // compute totals
      let spent = 0, value = 0;
      rawRows.forEach(r => {
        const tc  = parseFloat(r['Total Cost'].replace(/[^\d.-]/g,'')) || 0;
        const mv  = parseFloat(r['NZD'].replace(/[^\d.-]/g,''))       || 0;
        const mvu = parseFloat(r['Market Value'].replace(/[^\d.-]/g,'')) || 1;
        const costNZ = mvu ? tc * (mv / mvu) : 0;
        spent += costNZ;
        value += mv;
      });
      const profit = value - spent;

      // helper: create a card + container
      function makeCard(title, chartId) {
        const card = document.createElement('div');
        card.className = 'bg-gray-800 rounded-lg shadow-lg p-4 flex flex-col';
        card.innerHTML = `
          <h2 class="text-lg mb-2 text-center">${title}</h2>
          <div id="${chartId}"></div>
        `;
        dash.appendChild(card);
        return card;
      }

      // A) Allocation (donut)
      makeCard(`Allocation (NZD${memberView?' per member':''})`, 'allocationChart');
      new ApexCharts(document.querySelector('#allocationChart'), {
        chart: { type: 'donut', height: 240, toolbar: { show: false } },
        series: rawRows.map(r => (parseFloat(r['NZD'].replace(/[^\d.-]/g,''))||0)/f),
        labels: rawRows.map(r => r.Ticker),
        legend: { position: 'right', labels: { colors: '#fff' } },
        dataLabels: { enabled: false },
        theme: { mode: 'dark' },
        tooltip: { theme: 'dark' }
      }).render();

      // B) Summary (bar)
      makeCard(`Portfolio Summary (NZD${memberView?' per member':''})`, 'summaryChart');
      new ApexCharts(document.querySelector('#summaryChart'), {
        chart: { type: 'bar', height: 240, toolbar: { show: false } },
        series: [{ name: 'NZD', data: [spent/f, profit/f, value/f] }],
        xaxis: {
          categories: ['Spent','Profit','Value'],
          labels: { style: { colors: '#fff' } }
        },
        yaxis: {
          labels: {
            formatter: v => '$' + v.toLocaleString(),
            style: { colors: '#fff' }
          }
        },
        plotOptions: { bar: { borderRadius: 4 } },
        theme: { mode: 'dark' },
        tooltip: { theme: 'dark' }
      }).render();

      // C) Value Over Time (line)
      makeCard('Portfolio Value Over Time', 'valueLineChart');
      const dates = portfolioData.map(r => r.date);
      const vals  = portfolioData.map(r => r.value);
      const minV  = Math.min(...vals), maxV = Math.max(...vals);
      const margin = (maxV - minV) * 0.1;
      new ApexCharts(document.querySelector('#valueLineChart'), {
        chart: { type: 'line', height: 240, toolbar: { show: false } },
        series: [{ name: 'Value', data: vals }],
        xaxis: { categories: dates, labels: { style: { colors: '#fff' } } },
        yaxis: {
          min: minV - margin,
          max: maxV + margin,
          labels: {
            formatter: v => '$' + v.toLocaleString(),
            style: { colors: '#fff' }
          }
        },
        stroke: { curve: 'smooth', width: 2 },
        grid: { borderColor: '#374151' },
        theme: { mode: 'dark' },
        tooltip: { theme: 'dark' }
      }).render();

      // D) One card per holding (mixed bar + line)
      rawRows.forEach(r => {
        const tc  = parseFloat(r['Total Cost'].replace(/[^\d.-]/g,'')) || 0;
        const mv  = parseFloat(r['NZD'].replace(/[^\d.-]/g,''))       || 0;
        const mvu = parseFloat(r['Market Value'].replace(/[^\d.-]/g,'')) || 1;
        const costNZ = mvu ? tc * (mv / mvu) : 0;
        const profNZ = mv - costNZ;
        const pct    = parseFloat(r['% Change'].replace(/[^\d.-]/g,'')) || 0;

        const card = makeCard(r.Ticker, `chart-${r.Ticker}`);
        card.classList.add(profNZ >= 0 ? 'border-4 border-green-500' : 'border-4 border-red-500');

        new ApexCharts(card.querySelector(`#chart-${r.Ticker}`), {
          chart: { height: 260, toolbar: { show: false } },
          series: [
            { name: 'NZD',   type: 'column', data: [costNZ/f, mv/f, profNZ/f, null] },
            { name: '% Change', type: 'line',   data: [null, null, null, pct] }
          ],
          labels: ['Cost','Value','Profit','% Change'],
          yaxis: [
            {
              title: { text: 'NZD' },
              labels: {
                formatter: v => '$' + v.toLocaleString(),
                style: { colors: '#fff' }
              }
            },
            {
              opposite: true,
              title: { text: '% Change' },
              labels: {
                formatter: v => v + '%',
                style: { colors: '#fff' }
              }
            }
          ],
          plotOptions: { bar: { borderRadius: 4 } },
          stroke: { width: [0, 3], curve: 'smooth' },
          legend: { position: 'bottom', labels: { colors: '#fff' } },
          theme: { mode: 'dark' },
          tooltip: { theme: 'dark' }
        }).render();
      });
    }
  </script>
</body>
</html>

