<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>PLTR: Price + Your Trades</title>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.2/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <h1>PLTR: Price + Your Trades</h1>
  <canvas id="pltrChart" height="400"></canvas>
  <script>
    // …all of the Chart.js + PapaParse code we provided…
    const transactionsUrl =
      'https://docs.google.com/spreadsheets/d/e/2PACX-1vQEJMIKmxhiNNEJ8h-sgxpsSAT8ndO5TK0EVCijAoAv4y-cmmU0YSHFUX8mC6gMBouC9k50FVFQLawN/pub?output=csv';
    const alphaKey = 'VC0HKS05TBNC8AHS';

    // 1) load your transactions
    Papa.parse(transactionsUrl, {
      download: true,
      header: true,
      complete: ({ data }) => {
        // filter PLTR rows and separate buys/sells
        const pltrTxns = data.filter(r => r.Ticker === 'PLTR');
        const buyPoints  = pltrTxns
          .filter(r => r.Action === 'BUY')
          .map(r => ({ x: r.Date, y: +r.Price }));
        const sellPoints = pltrTxns
          .filter(r => r.Action === 'SELL')
          .map(r => ({ x: r.Date, y: +r.Price }));

        // 2) fetch PLTR price history
        fetch(
          `https://www.alphavantage.co/query?function=TIME_SERIES_DAILY_ADJUSTED` +
          `&symbol=PLTR&outputsize=compact&apikey=${alphaKey}`
        )
        .then(res => res.json())
        .then(json => {
          const series = json['Time Series (Daily)'];
          const dates  = Object.keys(series).sort();
          const prices = dates.map(d => +series[d]['4. close']);

          // today’s price point
          const today = dates[dates.length - 1];
          const todayPrice = prices[prices.length - 1];

          // 3) draw Chart.js
          new Chart(
            document.getElementById('pltrChart'),
            {
              data: {
                labels: dates,
                datasets: [
                  {
                    type: 'line',
                    label: 'Close Price (USD)',
                    data: prices,
                    yAxisID: 'price',
                    tension: 0.2,
                    borderWidth: 2
                  },
                  {
                    type: 'scatter',
                    label: 'Buys',
                    data: buyPoints,
                    yAxisID: 'price',
                    pointBackgroundColor: 'green',
                    pointRadius: 6
                  },
                  {
                    type: 'scatter',
                    label: 'Sells',
                    data: sellPoints,
                    yAxisID: 'price',
                    pointBackgroundColor: 'red',
                    pointRadius: 6
                  },
                  {
                    type: 'scatter',
                    label: 'Today',
                    data: [{ x: today, y: todayPrice }],
                    yAxisID: 'price',
                    pointBackgroundColor: 'blue',
                    pointRadius: 6
                  }
                ]
              },
              options: {
                scales: {
                  x: {
                    type: 'time',
                    time: {
                      parser: 'yyyy-MM-dd',
                      unit: 'day',
                      tooltipFormat: 'MMM dd'
                    }
                  },
                  price: {
                    type: 'linear',
                    position: 'left',
                    title: { display: true, text: 'Price (USD)' }
                  }
                }
              }
            }
          );
        });
      },
      error: err => console.error('Transactions load error:', err)
    });
  </script>
</body>
</html>

