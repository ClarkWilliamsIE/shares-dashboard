<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Winnerland - Login Trial</title>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- PapaParse -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.2/papaparse.min.js"></script>
  <!-- Supabase JS v2 -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    :root {
      color-scheme: dark;
    }
    body {
      margin: 0;
      padding: 1rem;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji";
      background: #121212;
      color: #fff;
    }
    h1 {
      text-align: center;
      margin-bottom: 0.5rem;
      color: #fff;
    }
    /* switch styling */
    .switch { position: relative; display: inline-block; width: 50px; height: 26px; margin-right: 0.5rem; vertical-align: middle; }
    .switch input { opacity: 0; width: 0; height: 0; }
    .slider { position: absolute; cursor: pointer; inset: 0; background-color: #3a3a3a; transition: .2s; border-radius: 26px; }
    .slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 4px; bottom: 4px; background-color: white; transition: .2s; border-radius: 50%; }
    input:checked + .slider { background-color: #2196F3; }
    input:checked + .slider:before { transform: translateX(24px); }

    /* layout */
    .topbar { display: flex; align-items: center; justify-content: center; gap: 1rem; flex-wrap: wrap; }
    .stack { display: flex; align-items: center; gap: 0.5rem; }
    .auth { display: grid; grid-template-columns: repeat(6, max-content); gap: 0.5rem; align-items: center; justify-content: center; margin-top: 0.5rem; }
    .auth input { padding: 0.45rem 0.6rem; background: #1e1e1e; border: 1px solid #333; color: #fff; border-radius: 6px; }
    .btn { padding: 0.45rem 0.7rem; background: #2a2a2a; border: 1px solid #3a3a3a; color: #fff; border-radius: 6px; cursor: pointer; }
    .btn:hover { background: #333; }
    .muted { opacity: 0.85; }

    .dashboard { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1rem; margin-top: 1rem; }
    .chart-card { background: #1e1e1e; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.25); padding: 1rem; display: flex; flex-direction: column; border: 3px solid transparent; }
    .chart-card h2 { margin: 0 0 0.5rem; font-size: 1.1rem; text-align: center; color: #fff; }
    .chart-container { position: relative; flex: 1; height: 200px; }
    .chart-container canvas { width: 100% !important; height: 100% !important; }

    .gate { max-width: 960px; margin: 1rem auto; }
      /* dialog styling */
    dialog { background:#1e1e1e; color:#fff; border:1px solid #333; border-radius:10px; padding:1rem; max-width:420px; }
    dialog input { width:100%; box-sizing:border-box; margin:.4rem 0; padding:.5rem; background:#161616; border:1px solid #333; color:#fff; border-radius:6px; }
    dialog .row { display:flex; gap:.5rem; justify-content:flex-end; margin-top:.5rem; }
  </style>
</head>
<body>
  <h1>Winnerland</h1>

  <!-- Top controls -->
  <div class="topbar">
    <div class="stack">
      <label class="switch">
        <input type="checkbox" id="memberToggle" />
        <span class="slider"></span>
      </label>
      <span>Member view</span>
    </div>
    <div class="stack">
      <span id="authStatus" class="muted">Not signed in</span>
    </div>
  </div>

  <!-- Auth controls -->
  <div class=\"auth\" id=\"authControls\">
    <input id=\"email\" type=\"email\" placeholder=\"email@example.com\" />
    <input id=\"password\" type=\"password\" placeholder=\"password\" />
    <label class=\"stack\" style=\"grid-column: span 2; align-items:center;\">
      <input id=\"staySignedIn\" type=\"checkbox\" checked />
      <span class=\"muted\">Stay signed in</span>
    </label>
    <button id=\"btnSignIn\" class=\"btn\">Login</button>
    <button id=\"btnSignOut\" class=\"btn\" style=\"display:none;\">Sign out</button>
    <button id=\"btnShowSignUp\" class=\"btn\" style=\"grid-column: span 2; background:#203320; border-color:#2f5f2f;\">Create account</button>
  </div>

  <!-- Member only area example, read only for now -->
  <dialog id=\"signupDialog\">
    <form method=\"dialog\" id=\"signupForm\">
      <h3 style=\"margin:0 0 .5rem;\">Create account</h3>
      <p class=\"muted\" style=\"margin:.25rem 0 .5rem;\">Use your email and a strong password. You can close this dialog to cancel.</p>
      <input id=\"suEmail\" type=\"email\" placeholder=\"email@example.com\" />
      <input id=\"suPassword\" type=\"password\" placeholder=\"password\" />
      <div class=\"row\">
        <button id=\"btnSignUpModal\" class=\"btn\">Sign up</button>
        <button class=\"btn\" value=\"cancel\">Cancel</button>
      </div>
    </form>
  </dialog>

  <div id=\"proFeatures\" class=\"gate\" style="display:none;">
    <div class="chart-card">
      <h2>Member tools</h2>
      <p class="muted" style="text-align:center;">You are signed in. You can unlock interactive features here later.</p>
    </div>
  </div>

  <div class="dashboard" id="dashboard"></div>

  <script>
    // ---------- Supabase setup ----------
    const SUPABASE_URL = "https://acdlgvcxzxjvcwiqlydj.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFjZGxndmN4enhqdmN3aXFseWRqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY2Mjc5NzksImV4cCI6MjA3MjIwMzk3OX0.9ZUURjJT73Igd2tAOv8aSZUmlkEf7DIzmOAGBSjWqCI";

    // Storage for non persistent sessions
    const _mem = {};
    const memoryStorage = {
      getItem: (k) => Object.prototype.hasOwnProperty.call(_mem, k) ? _mem[k] : null,
      setItem: (k, v) => { _mem[k] = v; },
      removeItem: (k) => { delete _mem[k]; }
    };

    const supabasePersist = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
      auth: { persistSession: true, autoRefreshToken: true, detectSessionInUrl: true, storage: window.localStorage }
    });
    const supabaseEphemeral = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
      auth: { persistSession: true, autoRefreshToken: true, detectSessionInUrl: true, storage: memoryStorage }
    });

    // Current client pointer, default to persistent so returning users auto sign in
    let supabase = supabasePersist;

    // ---------- Element refs ----------
    const authStatus = document.getElementById('authStatus');
    const btnSignIn = document.getElementById('btnSignIn');
    const btnSignOut = document.getElementById('btnSignOut');
    const btnShowSignUp = document.getElementById('btnShowSignUp');
    const emailEl = document.getElementById('email');
    const passEl = document.getElementById('password');
    const stayEl = document.getElementById('staySignedIn');
    const proFeatures = document.getElementById('proFeatures');
    const memberToggle = document.getElementById('memberToggle');

    // Sign up dialog elements
    const signupDialog = document.getElementById('signupDialog');
    const suEmailEl = document.getElementById('suEmail');
    const suPassEl = document.getElementById('suPassword');
    const btnSignUpModal = document.getElementById('btnSignUpModal');

    async function syncActiveClient() {
      const a = await supabasePersist.auth.getSession();
      const b = await supabaseEphemeral.auth.getSession();
      if (a.data.session) { supabase = supabasePersist; return a.data.session; }
      if (b.data.session) { supabase = supabaseEphemeral; return b.data.session; }
      supabase = supabasePersist; // default
      return null;
    }

    async function refreshAuthUI() {
      const session = await syncActiveClient();
      const signedIn = !!session;
      authStatus.textContent = signedIn ? `Signed in as ${session.user.email}` : 'Not signed in';
      btnSignOut.style.display = signedIn ? 'inline-block' : 'none';
      btnSignIn.style.display = signedIn ? 'none' : 'inline-block';
      emailEl.style.display = signedIn ? 'none' : 'inline-block';
      passEl.style.display = signedIn ? 'none' : 'inline-block';
      stayEl.parentElement.style.display = signedIn ? 'none' : 'flex';
      btnShowSignUp.style.display = signedIn ? 'none' : 'inline-block';
      proFeatures.style.display = signedIn ? 'block' : 'none';
    }

    // Listen on both clients
    [supabasePersist, supabaseEphemeral].forEach(c => c.auth.onAuthStateChange(() => { refreshAuthUI(); }));

    // Open the sign up dialog on request
    btnShowSignUp.addEventListener('click', async () => {
      const session = await syncActiveClient();
      if (session) { alert('You are signed in already. Sign out first if you want to create a new account'); return; }
      signupDialog.showModal();
      suEmailEl.focus();
    });

    // Handle sign up in the dialog, default to persistent accounts
    btnSignUpModal.addEventListener('click', async (e) => {
      e.preventDefault();
      const email = suEmailEl.value.trim();
      const password = suPassEl.value;
      if (!email || !password) { alert('Enter email and password'); return; }
      const { error } = await supabasePersist.auth.signUp({ email, password });
      if (error) { alert(error.message); return; }
      signupDialog.close();
      alert('Check your email for a confirmation link');
    });

    // Login picks persistent or ephemeral based on Stay signed in
    btnSignIn.addEventListener('click', async () => {
      const email = emailEl.value.trim();
      const password = passEl.value;
      if (!email || !password) { alert('Enter email and password'); return; }
      supabase = stayEl.checked ? supabasePersist : supabaseEphemeral;
      const { error } = await supabase.auth.signInWithPassword({ email, password });
      if (error) alert(error.message);
    });

    // Sign out from both clients to be safe
    btnSignOut.addEventListener('click', async () => {
      await Promise.allSettled([
        supabasePersist.auth.signOut(),
        supabaseEphemeral.auth.signOut()
      ]);
    });

    // Gate the Member view toggle
    memberToggle.addEventListener('change', async e => {
      const session = await syncActiveClient();
      if (!session) { e.target.checked = false; alert('Please sign in to use Member view'); return; }
      renderCharts(true);
    });

    // Initial UI paint
    refreshAuthUI();

    // ---------- Data and charts ----------
    const csvUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQEJMIKmxhiNNEJ8h-sgxpsSAT8ndO5TK0EVCijAoAv4y-cmmU0YSHFUX8mC6gMBouC9k50FVFQLawN/pub?gid=1666283294&single=true&output=csv';

    let rawRows = [];
    let portfolioData = [];

    Papa.parse(csvUrl, {
      download: true,
      header: true,
      complete: ({ data }) => {
        rawRows = data.filter(r => parseFloat(r['QTY']) > 0 && r.Ticker);
        portfolioData = data.map(row => {
          const date = row['M'];
          const portfolioValue = parseFloat(row['N']) || 0;
          if (!portfolioValue) return null;
          return { date, portfolioValue };
        }).filter(Boolean);
        renderCharts(false);
      },
      error: err => console.error('CSV load error:', err)
    });

    function renderCharts(memberView) {
      const f = memberView ? 14 : 1;
      const dashboard = document.getElementById('dashboard');
      dashboard.innerHTML = '';

      // Totals
      let totalSpent = 0, totalValue = 0;
      rawRows.forEach(r => {
        const tcUsd   = parseFloat((r['Total Cost'] || '').replace(/[^\d.-]/g,'')) || 0;
        const mvUsd   = parseFloat((r['Market Value'] || '').replace(/[^\d.-]/g,'')) || 0;
        const mvNzd   = parseFloat((r['NZD'] || '').replace(/[^\d.-]/g,''))       || 0;
        const costNzd = mvUsd ? tcUsd * (mvNzd / mvUsd) : 0;
        totalSpent += costNzd;
        totalValue += mvNzd;
      });
      const totalProfit = totalValue - totalSpent;

      // PIE card
      const pieCard = document.createElement('div');
      pieCard.className = 'chart-card';
      pieCard.innerHTML = `
        <h2>Allocation ${memberView ? '(per member NZD)' : ''}</h2>
        <div class="chart-container"><canvas id="summaryPie"></canvas></div>
      `;
      dashboard.appendChild(pieCard);

      // BAR card
      const barCard = document.createElement('div');
      barCard.className = 'chart-card';
      barCard.innerHTML = `
        <h2>Portfolio Summary ${memberView ? '(per member NZD)' : ''}</h2>
        <div class="chart-container"><canvas id="summaryBar"></canvas></div>
      `;
      dashboard.appendChild(barCard);

      // Line card
      const lineCard = document.createElement('div');
      lineCard.className = 'chart-card';
      lineCard.innerHTML = `
        <h2>Portfolio Value Over Time</h2>
        <div class="chart-container"><canvas id="portfolioValueLine"></canvas></div>
      `;
      dashboard.appendChild(lineCard);

      const lineLabels = portfolioData.map(r => r.date);
      const lineVals = portfolioData.map(r => r.portfolioValue);
      const minValue = Math.min(...lineVals);
      const maxValue = Math.max(...lineVals);
      const margin = (maxValue - minValue) * 0.1;

      new Chart(document.getElementById('portfolioValueLine'), {
        type: 'line',
        data: { labels: lineLabels, datasets: [{ label: 'Portfolio Value (NZD)', data: lineVals, fill: false, borderColor: 'rgba(75,192,192,1)', tension: 0.1 }] },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: {
              min: minValue - margin,
              max: maxValue + margin,
              ticks: { callback: v => '$' + Number(v).toLocaleString(undefined, { minimumFractionDigits: 2 }) },
              grid: { color: '#444', borderColor: '#444' }
            },
            x: { grid: { color: '#444' } }
          },
          plugins: { legend: { labels: { color: '#fff' } } }
        }
      });

      // PIE chart
      const pieLabels = rawRows.map(r => r.Ticker);
      const pieData = rawRows.map(r => (parseFloat((r['NZD'] || '').replace(/[^\d.-]/g,'')) || 0) / f);
      new Chart(document.getElementById('summaryPie'), {
        type: 'doughnut',
        data: { labels: pieLabels, datasets: [{ data: pieData }] },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { position: 'right', labels: { color: '#fff' } } },
          elements: { arc: { borderWidth: 0 } }
        }
      });

      // BAR chart
      new Chart(document.getElementById('summaryBar'), {
        type: 'bar',
        data: {
          labels: ['Spent', 'Profit', 'Value'],
          datasets: [{ label: 'NZD', data: [ totalSpent / f, totalProfit / f, totalValue / f ], backgroundColor: [ 'rgba(54,162,235,0.6)', 'rgba(255,205,86,0.6)', 'rgba(75,192,192,0.6)' ] }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: { beginAtZero: true, ticks: { callback: v => '$' + Number(v).toLocaleString(undefined, { minimumFractionDigits: 2 }) }, grid: { color: '#444', borderColor: '#444' } },
            x: { grid: { color: '#444' } }
          },
          plugins: { legend: { display: false } }
        }
      });

      // cards for each holding
      rawRows.forEach(r => {
        const tcUsd = parseFloat((r['Total Cost'] || '').replace(/[^\d.-]/g, '')) || 0;
        const mvUsd = parseFloat((r['Market Value'] || '').replace(/[^\d.-]/g, '')) || 0;
        const mvNzd = parseFloat((r['NZD'] || '').replace(/[^\d.-]/g, '')) || 0;
        const costNzd = mvUsd ? tcUsd * (mvNzd / mvUsd) : 0;
        const profitNzd = mvNzd - costNzd;
        const pctChange = parseFloat((r['% Change'] || '').replace(/[^\d.-]/g, '')) || 0;

        const card = document.createElement('div');
        card.className = 'chart-card';
        card.innerHTML = `
          <h2>${r.Ticker}</h2>
          <div class="chart-container"><canvas id="chart-${r.Ticker}"></canvas></div>
        `;
        card.style.border = profitNzd >= 0 ? '3px solid #28a745' : '3px solid #dc3545';
        document.getElementById('dashboard').appendChild(card);

        new Chart(document.getElementById(`chart-${r.Ticker}`), {
          data: {
            labels: ['Cost', 'Value', 'Profit', '% Change'],
            datasets: [
              { type: 'bar', label: 'NZD', data: [ costNzd / f, mvNzd / f, profitNzd / f, null ], backgroundColor: [ 'rgba(54,162,235,0.6)', 'rgba(75,192,192,0.6)', 'rgba(255,205,86,0.6)' ] },
              { type: 'line', label: '% Change', data: [ null, null, null, pctChange ], yAxisID: 'PCT', borderColor: 'rgba(255,99,132,0.8)', backgroundColor: 'rgba(255,99,132,0.4)', tension: 0.3, pointRadius: 4, fill: false }
            ]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              y: { beginAtZero: true, title: { display: true, text: 'NZD' }, ticks: { callback: v => '$' + Number(v).toLocaleString() }, grid: { color: '#444' } },
              PCT: { type: 'linear', position: 'right', title: { display: true, text: '% Change' }, grid: { drawOnChartArea: false }, ticks: { callback: v => v + '%' } }
            },
            plugins: {
              tooltip: { callbacks: { label: ctx => ctx.dataset.type === 'line' ? `% Change: ${ctx.parsed.y}%` : `NZD $${Number(ctx.parsed.y).toLocaleString()}` } },
              legend: { position: 'bottom' }
            }
          }
        });
      });
    }

    // First paint
    refreshAuthUI();
  </script>
</body>
</html>

