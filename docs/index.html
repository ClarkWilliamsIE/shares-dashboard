<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Winnerland, Main</title>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.2/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    :root { color-scheme: dark; }
    body { margin: 0; padding: 1rem; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial; background:#121212; color:#fff; }
    h1 { text-align:center; margin-bottom:0.5rem; }
    .gate { max-width: 1024px; margin: 1rem auto; }
    .dashboard { display:grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap:1rem; margin-top:1rem; }
    .chart-card { background:#1e1e1e; border-radius:10px; box-shadow:0 2px 8px rgba(0,0,0,0.25); padding:1rem; border:3px solid transparent; }
    .chart-card h2 { margin:0 0 0.5rem; font-size:1.1rem; text-align:center; }
    .chart-container { position:relative; height:200px; }
    .chart-container canvas { width:100% !important; height:100% !important; }
    #log { max-width: 1024px; margin: 1rem auto; background:#0f0f0f; border:1px solid #333; padding:0.5rem 0.75rem; border-radius:8px; white-space:pre-wrap; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size:12px; }
    .hidden { display:none; }
    iframe.cardframe { width:100%; border:0; min-height:360px; border-radius:8px; overflow:hidden; }
  </style>
</head>
<body>
  <h1>Winnerland</h1>

  <!-- Member area shell that swaps between Login card and Watchlist card -->
  <div class="gate">
    <div class="chart-card">
      <h2 id="memberTitle">Member area</h2>

      <iframe
        id="loginFrame"
        class="cardframe"
        src="./login.html"
        title="Login"
        loading="lazy"
        referrerpolicy="same-origin"
        sandbox="allow-same-origin allow-scripts allow-forms"
      ></iframe>

      <iframe
        id="watchlistFrame"
        class="cardframe hidden"
        src="./watchlist.html"
        title="Shared watchlist"
        loading="lazy"
        referrerpolicy="same-origin"
        sandbox="allow-same-origin allow-scripts allow-forms"
      ></iframe>
    </div>
  </div>

  <!-- Public charts -->
  <div class="dashboard" id="dashboard"></div>

  <div id="log">Status, loading...</div>

  <script>
    /* logger */
    const logBox = document.getElementById('log');
    function logLine(msg) { console.log(msg); logBox.textContent += "\\n" + msg; }
    logBox.textContent = "Status, booting app...";

    /* Supabase, read only use to determine session */
    const SUPABASE_URL = "https://acdlgvcxzxjvcwiqlydj.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFjZGxndmN4enhqdmN3aXFseWRqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY2Mjc5NzksImV4cCI6MjA3MjIwMzk3OX0.9ZUURjJT73Igd2tAOv8aSZUmlkEf7DIzmOAGBSjWqCI";
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
      auth: { persistSession: true, autoRefreshToken: true, detectSessionInUrl: true }
    });

    const loginFrame = document.getElementById('loginFrame');
    const watchlistFrame = document.getElementById('watchlistFrame');
    const memberTitle = document.getElementById('memberTitle');

    function showLoginCard() {
      memberTitle.textContent = "Member area, please log in";
      loginFrame.classList.remove('hidden');
      watchlistFrame.classList.add('hidden');
      // refresh login UI state
      loginFrame.src = loginFrame.src;
    }
    function showWatchlistCard() {
      memberTitle.textContent = "Member tools";
      watchlistFrame.classList.remove('hidden');
      loginFrame.classList.add('hidden');
      // ask watchlist to refresh its auth view
      watchlistFrame.contentWindow && watchlistFrame.contentWindow.postMessage({ type:'forceAuthRefresh' }, '*');
    }

    /* listen for child messages */
    window.addEventListener('message', evt => {
      const data = evt.data || {};
      if (data.type === 'loginHeight')  loginFrame.style.height = Math.max(360, Number(data.height) || 360) + 'px';
      if (data.type === 'watchlistHeight') watchlistFrame.style.height = Math.max(360, Number(data.height) || 360) + 'px';

      if (data.type === 'auth' && data.status === 'signedIn') { logLine("Auth message, signed in"); showWatchlistCard(); }
      if (data.type === 'auth' && data.status === 'signedOut') { logLine("Auth message, signed out"); showLoginCard(); }

      if (data.type === 'openLogin') { showLoginCard(); }
    }, false);

    /* also react to real auth changes, in case messages fail */
    supabase.auth.onAuthStateChange(async (_event, session) => {
      if (session && session.user) { showWatchlistCard(); }
      else { showLoginCard(); }
    });

    /* initial session check */
    (async function syncFromSession() {
      try {
        const { data: { session } } = await supabase.auth.getSession();
        if (session && session.user) showWatchlistCard(); else showLoginCard();
      } catch (e) {
        logLine("Session check error, " + e.message);
        showLoginCard();
      }
    })();

    /* charts */
    const dashboard = document.getElementById('dashboard');
    const csvUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQEJMIKmxhiNNEJ8h-sgxpsSAT8ndO5TK0EVCijAoAv4y-cmmU0YSHFUX8mC6gMBouC9k50FVFQLawN/pub?gid=1666283294&single=true&output=csv';

    let rawRows = [];
    let portfolioData = [];

    function numFromCell(val) { if (val == null) return 0; return parseFloat(String(val).replace(/[^\d.-]/g,'')) || 0; }
    function safeTickerId(t) { return String(t || 'TICKER').replace(/[^A-Za-z0-9_-]/g, '_'); }
    function buildPortfolioFromHeaders(rows) {
      let dateKey = null, valueKey = null;
      const headers = rows.length ? Object.keys(rows[0]) : [];
      const datePrefs = ['Date','date','M'];
      const valuePrefs = ['Portfolio Value','portfolio value','Value','N'];
      for (const k of datePrefs) if (headers.includes(k)) { dateKey = k; break; }
      for (const k of valuePrefs) if (headers.includes(k)) { valueKey = k; break; }
      if (!dateKey || !valueKey) return [];
      return rows.map(r => {
        const date = r[dateKey];
        const v = numFromCell(r[valueKey]);
        if (!date || !isFinite(v) || v <= 0) return null;
        return { date, portfolioValue: v };
      }).filter(Boolean);
    }
    function ensureDemoWhenEmpty() {
      const needDemo = portfolioData.length === 0 && rawRows.length === 0;
      if (!needDemo) return;
      logLine("CSV looked empty, using demo data");
      rawRows = [
        { Ticker: 'AAPL', 'Total Cost': '1000', 'Market Value': '1200', 'NZD': '2000', '% Change': '20', QTY: '1' },
        { Ticker: 'MSFT', 'Total Cost': '800', 'Market Value': '900', 'NZD': '1500', '% Change': '12.5', QTY: '1' }
      ];
      portfolioData = [
        { date: '2025-07', portfolioValue: 2600 },
        { date: '2025-08', portfolioValue: 2950 },
        { date: '2025-09', portfolioValue: 3100 }
      ];
    }
    function loadCsvAndRender() {
      logLine("Loading CSV, " + csvUrl);
      Papa.parse(csvUrl, {
        download: true, header: true, skipEmptyLines: true,
        complete: ({ data }) => {
          try {
            const rows = Array.isArray(data) ? data : [];
            rawRows = rows.filter(r => numFromCell(r['QTY']) > 0 && r['Ticker']);
            portfolioData = buildPortfolioFromHeaders(rows);
            ensureDemoWhenEmpty();
            logLine("CSV parsed, holdings " + rawRows.length + ", points " + portfolioData.length);
            renderCharts();
          } catch (e) { logLine("Parse error, " + e.message); ensureDemoWhenEmpty(); renderCharts(); }
        },
        error: err => { logLine("CSV load error, " + err); ensureDemoWhenEmpty(); renderCharts(); }
      });
    }
    function renderCharts() {
      dashboard.innerHTML = '';

      let totalSpent = 0, totalValue = 0;
      rawRows.forEach(r => {
        const tcUsd = numFromCell(r['Total Cost']);
        const mvUsd = numFromCell(r['Market Value']);
        const mvNzd = numFromCell(r['NZD']);
        const costNzd = mvUsd ? tcUsd * (mvNzd / mvUsd) : 0;
        totalSpent += costNzd; totalValue += mvNzd;
      });
      const totalProfit = totalValue - totalSpent;

      const pieCard = document.createElement('div');
      pieCard.className = 'chart-card';
      pieCard.innerHTML = `<h2>Allocation</h2><div class="chart-container"><canvas id="summaryPie"></canvas></div>`;
      dashboard.appendChild(pieCard);

      const barCard = document.createElement('div');
      barCard.className = 'chart-card';
      barCard.innerHTML = `<h2>Portfolio Summary</h2><div class="chart-container"><canvas id="summaryBar"></canvas></div>`;
      dashboard.appendChild(barCard);

      const lineCard = document.createElement('div');
      lineCard.className = 'chart-card';
      lineCard.innerHTML = `<h2>Portfolio Value Over Time</h2><div class="chart-container"><canvas id="portfolioValueLine"></canvas></div>`;
      dashboard.appendChild(lineCard);

      try {
        const lineLabels = portfolioData.map(r => r.date);
        const lineVals = portfolioData.map(r => r.portfolioValue);
        if (lineVals.length) {
          const minValue = Math.min.apply(null, lineVals);
          const maxValue = Math.max.apply(null, lineVals);
          const margin = Math.max(1, (maxValue - minValue) * 0.1);
          new Chart(document.getElementById('portfolioValueLine'), {
            type: 'line',
            data: { labels: lineLabels, datasets: [{ label: 'Portfolio Value (NZD)', data: lineVals, fill:false, borderColor:'rgba(75,192,192,1)', tension:0.1 }] },
            options: {
              responsive:true, maintainAspectRatio:false,
              scales: {
                y: { min:minValue - margin, max:maxValue + margin, ticks:{ callback:v => '$' + Number(v).toLocaleString(undefined, { minimumFractionDigits:2 }) }, grid:{ color:'#444' } },
                x: { grid:{ color:'#444' } }
              },
              plugins: { legend: { labels: { color:'#fff' } } }
            }
          });
        }
      } catch (e) { logLine("Line chart error, " + e.message); }

      try {
        const pieLabels = rawRows.length ? rawRows.map(r => r.Ticker) : ['None'];
        const pieData = rawRows.length ? rawRows.map(r => numFromCell(r['NZD'])) : [1];
        new Chart(document.getElementById('summaryPie'), {
          type: 'doughnut',
          data: { labels: pieLabels, datasets: [{ data: pieData }] },
          options: { responsive:true, maintainAspectRatio:false, plugins:{ legend:{ position:'right', labels:{ color:'#fff' } } }, elements:{ arc:{ borderWidth:0 } } }
        });
      } catch (e) { logLine("Pie chart error, " + e.message); }

      try {
        new Chart(document.getElementById('summaryBar'), {
          type: 'bar',
          data: { labels: ['Spent','Profit','Value'], datasets: [{ label:'NZD', data:[totalSpent, totalProfit, totalValue], backgroundColor:['rgba(54,162,235,0.6)','rgba(255,205,86,0.6)','rgba(75,192,192,0.6)'] }] },
          options: { responsive:true, maintainAspectRatio:false, scales:{ y:{ beginAtZero:true, ticks:{ callback:v => '$' + Number(v).toLocaleString(undefined, { minimumFractionDigits:2 }) }, grid:{ color:'#444' } }, x:{ grid:{ color:'#444' } } }, plugins:{ legend:{ display:false } } }
        });
      } catch (e) { logLine("Bar chart error, " + e.message); }
    }

    loadCsvAndRender();
  </script>
</body>
</html>
    <div class="chart-card">
      <h2 id="memberTitle">Member area</h2>

      <!-- Login card iframe, visible when signed out -->
      <iframe
        id="loginFrame"
        class="cardframe"
        src="./login.html"
        title="Login"
        loading="lazy"
        referrerpolicy="same-origin"
        sandbox="allow-same-origin allow-scripts allow-forms"
      ></iframe>

      <!-- Watchlist card iframe, shown only when signed in -->
      <iframe
        id="watchlistFrame"
        class="cardframe hidden"
        src="./watchlist.html"
        title="Shared watchlist"
        loading="lazy"
        referrerpolicy="same-origin"
        sandbox="allow-same-origin allow-scripts allow-forms"
      ></iframe>
    </div>
  </div>

  <!-- Public charts -->
  <div class="dashboard" id="dashboard"></div>

  <div id="log">Status, loading...</div>

  <script>
    /* tiny logger */
    const logBox = document.getElementById('log');
    function logLine(msg) { console.log(msg); logBox.textContent += "\\n" + msg; }
    logBox.textContent = "Status, booting app...";

    /* swap helpers, no Supabase here */
    const loginFrame = document.getElementById('loginFrame');
    const watchlistFrame = document.getElementById('watchlistFrame');
    const memberTitle = document.getElementById('memberTitle');

    function showLoginCard() {
      memberTitle.textContent = "Member area, please log in";
      loginFrame.classList.remove('hidden');
      watchlistFrame.classList.add('hidden');
      // ensure login frame refreshes its form and state
      loginFrame.src = loginFrame.src;
    }
    function showWatchlistCard() {
      memberTitle.textContent = "Member tools";
      watchlistFrame.classList.remove('hidden');
      loginFrame.classList.add('hidden');
      // soft refresh the watchlist so it re checks its session
      watchlistFrame.contentWindow && watchlistFrame.contentWindow.postMessage({ type:'forceAuthRefresh' }, '*');
    }

    /* listen for child messages */
    window.addEventListener('message', evt => {
      const data = evt.data || {};
      // dynamic height from children
      if (data.type === 'loginHeight')  loginFrame.style.height = Math.max(360, Number(data.height) || 360) + 'px';
      if (data.type === 'watchlistHeight') watchlistFrame.style.height = Math.max(360, Number(data.height) || 360) + 'px';

      // auth state changes
      if (data.type === 'auth' && data.status === 'signedIn') {
        logLine("Auth message, signed in");
        showWatchlistCard();
      }
      if (data.type === 'auth' && data.status === 'signedOut') {
        logLine("Auth message, signed out");
        showLoginCard();
      }

      // watchlist asks to open login, for account or sign out
      if (data.type === 'openLogin') {
        showLoginCard();
      }
    }, false);

    /* charts demo, unchanged from earlier, no auth used */
    const dashboard = document.getElementById('dashboard');
    const csvUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQEJMIKmxhiNNEJ8h-sgxpsSAT8ndO5TK0EVCijAoAv4y-cmmU0YSHFUX8mC6gMBouC9k50FVFQLawN/pub?gid=1666283294&single=true&output=csv';

    let rawRows = [];
    let portfolioData = [];

    function numFromCell(val) { if (val == null) return 0; return parseFloat(String(val).replace(/[^\d.-]/g,'')) || 0; }
    function safeTickerId(t) { return String(t || 'TICKER').replace(/[^A-Za-z0-9_-]/g, '_'); }
    function buildPortfolioFromHeaders(rows) {
      let dateKey = null, valueKey = null;
      const headers = rows.length ? Object.keys(rows[0]) : [];
      const datePrefs = ['Date','date','M'];
      const valuePrefs = ['Portfolio Value','portfolio value','Value','N'];
      for (const k of datePrefs) if (headers.includes(k)) { dateKey = k; break; }
      for (const k of valuePrefs) if (headers.includes(k)) { valueKey = k; break; }
      if (!dateKey || !valueKey) return [];
      return rows.map(r => {
        const date = r[dateKey];
        const v = numFromCell(r[valueKey]);
        if (!date || !isFinite(v) || v <= 0) return null;
        return { date, portfolioValue: v };
      }).filter(Boolean);
    }
    function ensureDemoWhenEmpty() {
      const needDemo = portfolioData.length === 0 && rawRows.length === 0;
      if (!needDemo) return;
      logLine("CSV looked empty, using demo data");
      rawRows = [
        { Ticker: 'AAPL', 'Total Cost': '1000', 'Market Value': '1200', 'NZD': '2000', '% Change': '20', QTY: '1' },
        { Ticker: 'MSFT', 'Total Cost': '800', 'Market Value': '900', 'NZD': '1500', '% Change': '12.5', QTY: '1' }
      ];
      portfolioData = [
        { date: '2025-07', portfolioValue: 2600 },
        { date: '2025-08', portfolioValue: 2950 },
        { date: '2025-09', portfolioValue: 3100 }
      ];
    }
    function loadCsvAndRender() {
      logLine("Loading CSV, " + csvUrl);
      Papa.parse(csvUrl, {
        download: true, header: true, skipEmptyLines: true,
        complete: ({ data }) => {
          try {
            const rows = Array.isArray(data) ? data : [];
            rawRows = rows.filter(r => numFromCell(r['QTY']) > 0 && r['Ticker']);
            portfolioData = buildPortfolioFromHeaders(rows);
            ensureDemoWhenEmpty();
            logLine("CSV parsed, holdings " + rawRows.length + ", points " + portfolioData.length);
            renderCharts();
          } catch (e) { logLine("Parse error, " + e.message); ensureDemoWhenEmpty(); renderCharts(); }
        },
        error: err => { logLine("CSV load error, " + err); ensureDemoWhenEmpty(); renderCharts(); }
      });
    }
    function renderCharts() {
      dashboard.innerHTML = '';

      let totalSpent = 0, totalValue = 0;
      rawRows.forEach(r => {
        const tcUsd = numFromCell(r['Total Cost']);
        const mvUsd = numFromCell(r['Market Value']);
        const mvNzd = numFromCell(r['NZD']);
        const costNzd = mvUsd ? tcUsd * (mvNzd / mvUsd) : 0;
        totalSpent += costNzd; totalValue += mvNzd;
      });
      const totalProfit = totalValue - totalSpent;

      const pieCard = document.createElement('div');
      pieCard.className = 'chart-card';
      pieCard.innerHTML = `<h2>Allocation</h2><div class="chart-container"><canvas id="summaryPie"></canvas></div>`;
      dashboard.appendChild(pieCard);

      const barCard = document.createElement('div');
      barCard.className = 'chart-card';
      barCard.innerHTML = `<h2>Portfolio Summary</h2><div class="chart-container"><canvas id="summaryBar"></canvas></div>`;
      dashboard.appendChild(barCard);

      const lineCard = document.createElement('div');
      lineCard.className = 'chart-card';
      lineCard.innerHTML = `<h2>Portfolio Value Over Time</h2><div class="chart-container"><canvas id="portfolioValueLine"></canvas></div>`;
      dashboard.appendChild(lineCard);

      const lineLabels = portfolioData.map(r => r.date);
      const lineVals = portfolioData.map(r => r.portfolioValue);
      if (lineVals.length) {
        const minValue = Math.min.apply(null, lineVals);
        const maxValue = Math.max.apply(null, lineVals);
        const margin = Math.max(1, (maxValue - minValue) * 0.1);
        new Chart(document.getElementById('portfolioValueLine'), {
          type: 'line',
          data: { labels: lineLabels, datasets: [{ label: 'Portfolio Value (NZD)', data: lineVals, fill:false, borderColor:'rgba(75,192,192,1)', tension:0.1 }] },
          options: {
            responsive:true, maintainAspectRatio:false,
            scales: {
              y: { min:minValue - margin, max:maxValue + margin, ticks:{ callback:v => '$' + Number(v).toLocaleString(undefined, { minimumFractionDigits:2 }) }, grid:{ color:'#444' } },
              x: { grid:{ color:'#444' } }
            },
            plugins: { legend: { labels: { color:'#fff' } } }
          }
        });
      }

      const pieLabels = rawRows.length ? rawRows.map(r => r.Ticker) : ['None'];
      const pieData = rawRows.length ? rawRows.map(r => numFromCell(r['NZD'])) : [1];
      new Chart(document.getElementById('summaryPie'), {
        type: 'doughnut',
        data: { labels: pieLabels, datasets: [{ data: pieData }] },
        options: { responsive:true, maintainAspectRatio:false, plugins:{ legend:{ position:'right', labels:{ color:'#fff' } } }, elements:{ arc:{ borderWidth:0 } } }
      });

      new Chart(document.getElementById('summaryBar'), {
        type: 'bar',
        data: { labels: ['Spent','Profit','Value'], datasets: [{ label:'NZD', data:[totalSpent, totalProfit, totalValue], backgroundColor:['rgba(54,162,235,0.6)','rgba(255,205,86,0.6)','rgba(75,192,192,0.6)'] }] },
        options: { responsive:true, maintainAspectRatio:false, scales:{ y:{ beginAtZero:true, ticks:{ callback:v => '$' + Number(v).toLocaleString(undefined, { minimumFractionDigits:2 }) }, grid:{ color:'#444' } }, x:{ grid:{ color:'#444' } } }, plugins:{ legend:{ display:false } } }
      });
    }

    /* init */
    loadCsvAndRender();
  </script>
</body>
</html>


