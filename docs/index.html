<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Winnerland!</title>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- PapaParse -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.2/papaparse.min.js"></script>

  <style>
    body {
      margin: 0;
      padding: 1rem;
      font-family: sans-serif;
      background: #f5f7fa;
    }
    h1 {
      text-align: center;
      margin-bottom: 0.5rem;
    }
    /* switch styling */
    .switch {
      position: relative;
      display: inline-block;
      width: 50px;
      height: 26px;
      margin-right: 0.5rem;
      vertical-align: middle;
    }
    .switch input {
      opacity: 0;
      width: 0; height: 0;
    }
    .slider {
      position: absolute;
      cursor: pointer;
      top: 0; left: 0; right: 0; bottom: 0;
      background-color: #ccc;
      transition: .4s;
      border-radius: 26px;
    }
    .slider:before {
      position: absolute;
      content: "";
      height: 18px;
      width: 18px;
      left: 4px;
      bottom: 4px;
      background-color: white;
      transition: .4s;
      border-radius: 50%;
    }
    input:checked + .slider {
      background-color: #2196F3;
    }
    input:checked + .slider:before {
      transform: translateX(24px);
    }
    /* dashboard grid */
    .dashboard {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 1rem;
      margin-top: 1rem;
    }
    .chart-card {
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      padding: 1rem;
      display: flex;
      flex-direction: column;
    }
    .chart-card h2 {
      margin: 0 0 0.5rem;
      font-size: 1.1rem;
      text-align: center;
    }
    .chart-container {
      position: relative;
      flex: 1;
      height: 200px;
    }
    .chart-container canvas {
      width: 100% !important;
      height: 100% !important;
    }
  </style>
</head>

<body>
  <h1>Winnerland!</h1>
  <div style="text-align:center;">
    <label class="switch">
      <input type="checkbox" id="memberToggle">
      <span class="slider"></span>
    </label>
    <span>Member view</span>
  </div>
  <div class="dashboard" id="dashboard"></div>

  <script>
    const csvUrl =
      'https://docs.google.com/spreadsheets/d/e/2PACX-1vQEJMIKmxhiNNEJ8h-sgxpsSAT8ndO5TK0EVCijAoAv4y-cmmU0YSHFUX8mC6gMBouC9k50FVFQLawN/pub?gid=1666283294&single=true&output=csv';

    let rawRows = [];
    let portfolioData = [];  // To hold the portfolio value data for the line chart

    Papa.parse(csvUrl, {
      download: true,
      header: true,
      complete: ({ data }) => {
        // Filter out rows where quantity is 0 or less (no longer owned shares)
        rawRows = data.filter(r => parseFloat(r['QTY']) > 0 && r.Ticker);

        // Extract portfolio values for the line chart (from column M for date and column N for value)
        portfolioData = data.map(row => {
          const date = row['M']; // column M for date
          const portfolioValue = parseFloat(row['N']) || 0;  // column N for portfolio value
          
          // Exclude empty portfolio values (or zero)
          if (!portfolioValue) {
            return null; // If the portfolio value is empty or zero, discard this row
          }

          return {
            date: date,  // Store the raw date for display on the chart
            portfolioValue: portfolioValue  // Store the portfolio value
          };
        }).filter(row => row !== null);  // Filter out null values (empty or zero portfolio values)

        // Log the portfolioData to ensure it's correct
        console.log("Filtered Portfolio Data:", portfolioData);

        // Process best and worst performers
        const performanceData = calculatePerformance(portfolioData);
        const bestPerformers = performanceData.bestPerformers;
        const worstPerformers = performanceData.worstPerformers;

        // Render charts
        renderCharts(false, bestPerformers, worstPerformers);
        // Toggle handler
        document.getElementById('memberToggle')
          .addEventListener('change', e => renderCharts(e.target.checked, bestPerformers, worstPerformers));
      },
      error: err => console.error('CSV load error:', err)
    });

    // Function to calculate performance (top and bottom performers based on last week's data)
    function calculatePerformance(data) {
      // Assuming the portfolio data is ordered by date (most recent first)
      const latestData = data[data.length - 1];  // Most recent data
      const oneWeekAgo = data[data.length - 7];  // Data from 7 days ago (if available)

      // Calculate the percentage change between the most recent and 7 days ago
      const performanceData = data.map(row => {
        const date = row.date;
        const portfolioValue = row.portfolioValue;

        // Calculate percentage change from one week ago
        const change = oneWeekAgo ? ((portfolioValue - oneWeekAgo.portfolioValue) / oneWeekAgo.portfolioValue) * 100 : 0;

        return {
          date: date,
          portfolioValue: portfolioValue,
          change: change
        };
      });

      // Sort performance data by percentage change (ascending and descending)
      const sortedData = performanceData.sort((a, b) => b.change - a.change);  // Descending order

      // Get the top 5 best performers and the worst performers
      const bestPerformers = sortedData.slice(0, 5);
      const worstPerformers = sortedData.slice(-5).reverse(); // Reverse to get the worst at the top

      return { bestPerformers, worstPerformers };
    }

    function renderCharts(memberView, bestPerformers, worstPerformers) {
      const f = memberView ? 14 : 1;
      const dashboard = document.getElementById('dashboard');
      dashboard.innerHTML = '';

      // Add Top Performers Chart
      const topChartCard = document.createElement('div');
      topChartCard.className = 'chart-card';
      topChartCard.innerHTML = `
        <h2>Top Performers (Last Week)</h2>
        <div class="chart-container"><canvas id="topPerformersChart"></canvas></div>
      `;
      dashboard.appendChild(topChartCard);

      const topLabels = bestPerformers.map(r => r.date);
      const topData = bestPerformers.map(r => r.change);

      new Chart(document.getElementById('topPerformersChart'), {
        type: 'bar',
        data: {
          labels: topLabels,
          datasets: [{
            label: 'Percentage Change',
            data: topData,
            backgroundColor: 'rgba(75,192,192,0.6)'
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: {
              beginAtZero: true,
              ticks: { callback: function(value) { return value.toFixed(2) + '%' } }
            }
          }
        }
      });

      // Add Worst Performers Chart
      const worstChartCard = document.createElement('div');
      worstChartCard.className = 'chart-card';
      worstChartCard.innerHTML = `
        <h2>Worst Performers (Last Week)</h2>
        <div class="chart-container"><canvas id="worstPerformersChart"></canvas></div>
      `;
      dashboard.appendChild(worstChartCard);

      const worstLabels = worstPerformers.map(r => r.date);
      const worstData = worstPerformers.map(r => r.change);

      new Chart(document.getElementById('worstPerformersChart'), {
        type: 'bar',
        data: {
          labels: worstLabels,
          datasets: [{
            label: 'Percentage Change',
            data: worstData,
            backgroundColor: 'rgba(255,99,132,0.6)'
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: {
              beginAtZero: true,
              ticks: { callback: function(value) { return value.toFixed(2) + '%' } }
            }
          }
        }
      });
    }
  </script>
</body>
</html>

